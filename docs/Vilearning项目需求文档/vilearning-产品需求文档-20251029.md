# ViLearning 产品需求文档（2025-10-29）

## 0. 文档目的
- 梳理当前 FlowchartAI 代码库在 ViLearning 场景下的既有能力与技术栈。
- 明确本轮新增需求：接入火山引擎 DeepSeek 系列模型，将其设为主力模型并保留后续切换空间。
- 针对未来的上下文工程、结构化输出与分支对话需求，提出阶段性演进路线。

---

## 1. 当前项目现状

### 1.1 系统与架构
- **前端技术栈**：Next.js 15（App Router）、TypeScript、Tailwind CSS、Radix UI、Plait 白板。
- **状态管理**：TanStack Query + Zustand + LocalForage，本地持久化能力完备。
- **后端能力**：PostgreSQL + Drizzle ORM，Better Auth 做身份认证，支持访客与注册用户的 AI 使用配额管理。
- **文件结构**：API 位于 `src/app/api`，共享逻辑集中在 `src/lib`、`src/components`、`docs`，符合项目规范文档。

### 1.2 AI 服务现状（本次改造前）
- 既有流程图生成功能通过 `src/app/api/ai/chat/flowchart/route.ts` 调用 OpenRouter（OpenAI 兼容 SDK）。
- 默认模型为 `google/gemini-2.5-flash`，支持工具调用（`generate_flowchart`）与流式输出。
- AI 配额与日志：`src/lib/ai-usage.ts` 维护每日/月度限制，记录模型名称与调用结果。

### 1.3 白板与上下文
- 画布核心在 `src/components/canvas` 系列，支持 AI 对话侧栏、流程图渲染、Mermaid 结果注入。
- `aiContext` 中的 `canvasSnapshot`、`lastMermaid` 已为上下文工程预留接口，但尚未统一为“项目级高权重上下文”。
- 目前仅支持流程图输出，前端仍以流程图为主视图，没有通用 Display 节点体系。

### 1.4 文档与需求资产
- `docs/Vilearning项目需求文档` 下的 V2.0 资料强调：空间化学习、上下文工程、可扩展的 Display 管理、分支对话。
- `docs/API调用引导` 已提供火山引擎 DeepSeek v3.1、结构化输出、向量模型的接入文档，为后续扩展提供参考。

---

## 2. 需求焦点分析

### 2.1 核心目标一：AI 服务切换
- 主力模型切换为火山引擎 DeepSeek v3.1，同时要求**模块化配置**，便于后台开放更多模型（例如 Doubao、Gemini）。
- 环境变量需统一：`ARK_API_KEY`、`ARK_DEEPSEEK_MODEL_ID`、`AI_DEFAULT_MODEL_KEY`，保留 OpenRouter 备用。
- 兼容现有功能：仍需保留流式输出与工具调用能力，对图像模式要检测模型能力并降级处理。

### 2.2 核心目标二：上下文工程与 Display 扩展
- 需求文档强调“上下文即核心产品”，未来需：
  - 以白板/项目级上下文文件驱动 AI，设定高权重提示（`vilearning.md` 设想）。
  - 自动汇聚画布内容、选中区域上下文，通过服务端统一封装并发送给模型。
  - 支持多种 Display：思维导图、流程图、测验、卡片、时间线、版式化笔记等。

### 2.3 核心目标三：分支对话与版本管理
- 允许在任意节点建立分支会话，继承当前上下文继续推演，类似 Flowith 的多版本探索。
- 需要记录分支关系、上下文快照以及所使用的模型与 Prompt，保障可追溯性。

### 2.4 风险与挑战
- **API 配置复杂度**：需要确保不同模型的鉴权、Base URL、Header、能力差异（图像/工具调用）均可抽象。
- **上下文体积控制**：白板内容若全部注入，需设计压缩/摘要策略与限流机制。
- **结构化输出规范**：不同 Display 类型对 JSON schema 要求不同，需要约定统一格式与校验流程。
- **计费与配额**：多模型共存后，配额统计要记录“模型键值”，便于后续定价与分析。

---

## 3. 阶段性改进方案

### 阶段 0（已完成 / 即刻执行）
1. **AI 客户端抽象**  
   - 新增 `src/lib/ai-clients.ts`，将模型注册表、默认模型、可用能力统一管理。  
   - 支持火山引擎 DeepSeek v3.1，保留 OpenRouter 作为备用；根据模型能力自动降级图像模式。
2. **配置与文档更新**  
   - `.env.local.example`、README 更新 Ark 相关环境变量说明。
   - 在路由层记录实际使用的模型键值，便于后续计费统计。

### 阶段 1（近期：上下文与结构化输出基础）
1. **上下文管线重构**  
   - 设计 `ProjectContextService`：集中管理项目提示、白板摘要、选中节点内容，提供统一接口给 API 路由。
   - 支持“高权重项目提示文件”加载（例如 `vilearning.md`），并在请求中主动注入。
2. **Display 通用协议**  
   - 定义结构化输出 Schema（思维导图、流程图、卡片、测验等），在 AI 响应中强制返回 JSON。
   - 后端根据 Display 类型转译为前端节点，前端以插槽形式渲染，减少硬编码。
3. **模型能力元数据**  
   - 在模型配置中补充 `supports: { image, structuredOutput, reasoning }` 等字段，驱动前端可选项和后端校验。

### 阶段 2（中期：多模态与分支）
1. **分支会话管理**  
   - 数据模型设计：`conversation_sessions` 记录父子关系、使用模型、上下文快照 ID。
   - 前端呈现分支树与快速切换能力，允许在任意节点继续对话。
2. **结构化输出渲染层**  
   - 建立通用渲染管线，支持思维导图、流程图、表格、时间线等多种节点类型。
   - 为测试保留 JSON 快照与渲染快照，便于回放与调试。
3. **上下文精细投喂**  
   - 针对白板选中内容进行摘要/引用截取，限制 token，同步展示给用户验证。
   - 引入缓存策略，避免重复计算大型白板快照。

### 阶段 3（远期：生态与高级能力）
1. **模型市场化**：在后台提供模型切换界面，根据 `listAvailableModels()` 自动展示可用模型及能力标签。
2. **多引擎融合**：扩展向量检索、结构化输出（Ark 工具调用）以及深度思考模式（DeepSeek Reasoning）。
3. **审计与合规**：记录每次 AI 响应的 Prompt、模型、上下文来源，建立可追溯的审计面板。
4. **自动化测试**：为关键 API（流程图、结构化输出）编写集成测试，模拟不同模型与上下文场景。

---

## 4. 立即行动清单
- 验证生产与开发环境已配置 `ARK_API_KEY` 且网络可访问方舟 API。
- 与产品、设计同步模型切换后的文案与界面提示，确保用户知晓 DeepSeek 已成为默认模型。
- 制定上下文文件（如 `vilearning.md`）的目录与管理规范，准备后续上下文工程迭代。
- 评估前端对多 Display 类型的组件抽象，启动 Schema 设计工作。

---

## 5. 后续资料
- 《ViLearning 产品需求文档 (V2.0.0)》：战略定位、功能矩阵、用户旅程等基础背景。
- 《vilearning-项目探讨-251025.md》：对标产品与上下文工程灵感，可用于 Prompt 设计。
- 《火山引擎-文本生成-文档.md》《深度思考模型说明》：进一步探索 Ark API 的结构化输出与思考链特性。

> 本文档作为 2025-10-29 的阶段性共识，后续迭代请以此为基线进行增量更新。
