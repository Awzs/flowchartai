# ViLearning 空间化学习平台产品需求文档（2025-10-30）

> 文档属性：Product Requirement Document
> 面向对象：产品、设计、前端、后端、AI、运营团队
> 更新历史：基于 2025-10-25、2025-10-28、2025-10-29 多份资料统一整理，新增白板内 AI 对话与上下文工程方案

---

## 1. 概述与目标

- **产品愿景**：构建面向知识工作者的空间化学习与创作工作台，通过 AI + 白板协同，让碎片资料自动组织为可视化知识网络，并支持持续迭代。
- **MVP 聚焦人群**：在总体定位为知识工作者的前提下，首批仍以 *商科留学规划* 与 *ADHD 多线程学习* 作为展示样板，用真实案例验证价值。
- **核心目标**：
  1. 实现白板内外双入口 AI 交互（侧栏流程图、画布卡片对话），并为未来统一底部对话栏预留路线。
  2. 完成流程图（已具备）+ 思维导图生成、上下文选取、项目级 Markdown 仓的闭环。
  3. 预留上下文工程与技能包（Skill）体系，支撑后续结构化输出扩展与专业化场景。

---

## 2. 用户洞察与调研结论

- **调研方法**：用户访谈 30 人（15 名商科留学生、10 名 ADHD 学习者、5 名相关领域 KOL）+ 问卷 200 份。
- **样本特征**：
  - 年龄集中 18-28 岁，70% 使用过思维导图 / 白板工具。
  - 痛点聚焦“内容分散难整合”“多任务切换效率低”“规划缺乏可视化联动”。
- **关键结论**：
  - 85% ADHD 学习者需要“拖拽式多任务关联”与并行任务展示。
  - 90% 商科留学生希望规划内容可编辑、节点互联并可导出行动列表。
  - KOL 强调 AI 应能继承上下文继续深化，而非孤立问答。
- **商业洞察**：尽管长远方向为通用知识工作者，但垂直案例可降低学习成本，为营销与教学合作提供素材。

---

## 3. 使用场景与任务流程

### 3.1 通用知识工作者（研究生/咨询/产品）
1. 创建项目 → 设置项目指令（语气、输出要求）→ 上传资料或写入 Markdown 知识库。
2. 白板一级纵向骨架中输入主题，AI 自动生成初始思维导图容器节点。
3. 用户框选节点 → 打开底部对话栏或画布卡片对话，选择输出格式（普通对话/流程图容器/思维导图容器/卡片）。
4. AI 先给出分析草稿，用户确认后写入白板：普通回复以卡片呈现，结构化内容落在对应容器内。
5. 针对关键结论建立分支会话，对比不同方案 → 输出 Markdown/图谱 → 导出分享。

### 3.2 商科留学规划案例（MVP 展示）
1. 在项目左栏上传目标学校、简历、时间线资料，设置指令“语气正式、按季度规划”。
2. 白板创建“申请阶段流”一级节点，AI 生成学习、实习、文书等分支思维导图容器。
3. 选中“实习准备”节点 → 底部对话栏选择“流程图”输出 → AI 提供结构草稿 → 用户确认后生成流程图容器；引用差旅预算表。
4. 再复制分支生成“不出国备选方案”，最终导出对比表格或卡片。

### 3.3 ADHD 多线程学习
1. 白板一级纵向划分“技能学习”“生活维护”“健康管理”三条主线。
2. 通过底部对话栏选择“普通对话”生成卡片或“表格”生成任务看板容器；启用 Skill“番茄任务板”自动附加检查项。
3. 通过分支管理工作日/周末不同节奏，AI 根据已完成节点生成总结卡片及提醒。

---

## 4. 产品定位与价值主张

1. **空间化知识网络**：结合无界白板与 AI 自动结构化，让信息以节点+连接呈现，强化记忆与规划能力。
2. **上下文驱动交互**：项目 Markdown、白板快照、节点选区组成多层上下文，确保 AI 输出贴合项目状态。
3. **技能化扩展**：借鉴 Claude Skills，将行业模板、学习框架封装成技能包，按需加载到对话中，提供专业化结果。

---

## 5. 信息架构与模块划分

```
┌────────────────────────────────────────────────────────┐
│ 层级           │ 说明                                    │
├────────────────┼────────────────────────────────────────┤
│ 白板层         │ Flowith 式一级纵向主干 + 自由拖拽的     │
│                │ 二级内容块；Display 容器承载结构化输出， │
│                │ 支持双击进入编辑模式                    │
├────────────────┼────────────────────────────────────────┤
│ AI 交互层      │ 当前：侧栏流程图助手 + 画布卡片对话；   │
│                │ 规划：统一底部对话栏，选择输出格式并先  │
│                │ 生成分析草稿                           │
├────────────────┼────────────────────────────────────────┤
│ Display 层     │ 流程图、思维导图、卡片、测验、表格、时间线等 │
│                │ 容器化渲染，统一的 Schema/交互协议     │
├────────────────┼─────────────────────────────────────┤
│ 上下文工程层   │ ProjectContextService 读取 Markdown、 │
│                │ Skill 元数据、画布快照、节点选区，管理 │
│                │ Token 预算                            │
├────────────────┼─────────────────────────────────────┤
│ 模型与计费层   │ `ai-clients.ts` 注册多模型，记录能力   │
│                │ 标签与配额，支持切换与并行调用          │
└──────────────────────────────────────────────────────┘
```

---

## 6. 核心功能定义与优先级

| 优先级 | 功能项 | 说明 | 关联阶段 |
|--------|--------|------|----------|
| P0 | 白板 Flowith 式一级结构 + 二级自由节点 | 一级纵向模块可批量生成，二级节点可拖拽、连线、自定义布局 | MVP |
| P0 | Display 容器节点（流程图/思维导图） | 白板内生成可缩放容器，双击进入编辑模式 | MVP |
| P0 | 底部/侧栏双入口交互 | 当前暂保留侧栏，以底部对话栏为未来入口；可选择输出格式并先展示草稿 | MVP |
| P0 | 画布卡片对话节点（继承分支上下文） | 卡片内输入/输出，默认挂接当前分支，支持复制与横向排列多模型结果 | MVP |
| P0 | 选区上下文追问 | 框选节点作为上下文，调用 API 生成新卡片或 Display 容器 | MVP |
| P0 | 项目 Markdown 仓 + 指令管理 | 左侧抽屉管理 `.md` 文件，划分高权重指令/参考资料 | MVP |
| P0 | 分支/版本管理 | 卡片节点支持“一问多答”“衍生分支”，记录父子关系 | MVP |
| P1 | Skill 插件体系 | 按项目启用行业模板，提供元数据与资源加载 | 阶段 1 |
| P1 | 多 Display 输出：表格/卡片/时间线 | 完善结构化输出解析与前端渲染 | 阶段 1 |
| P1 | 上下文压缩与 Token 预算提示 | 计算上下文长度，必要时摘要压缩并回传剩余预算 | 阶段 1 |
| P2 | 引用追溯 + 文档索引 | 显示引用来源、高亮原文，提供跳转 | 阶段 2 |
| P2 | 自动布局算法 | 力导向/树状布局，保证节点可视性 | 阶段 2 |
| P2 | 实时协作与权限 | 多人同步、评论、权限控制 | 阶段 3 |

---

## 7. MVP 范围与验收标准

### 功能范围
```
✅ Flowith 式一级结构 + 二级节点自由拖拽
✅ Display 容器：流程图（已有）+ 思维导图生成与渲染
✅ 当前侧栏流程图入口 + 画布卡片对话双入口（为底部统一入口做准备）
✅ 选区上下文提问并生成卡片或 Display 容器
✅ 左侧 Markdown 仓（高权重指令 + 资料）基础版
✅ 分支/版本管理（同卡片内多回答 + 分支树）
❌ 暂不实现引用追溯、自动布局、协作
❌ 暂不接入文件上传/RAG（留待阶段 1）
```

### 验收指标
- 输入 600 字文本 → 3 秒内生成基础思维导图节点。
- 单卡片支持至少 2 个模型并行输出，响应延迟 < 5 秒。
- 框选 3 个节点提问 → 新 Display 容器正确引用上下文。
- 双击流程图/思维导图容器可进入编辑模式，退出后布局保持稳定。
- 底部对话栏可切换输出格式，并在确认后写入容器/卡片。
- 刷新后白板结构、分支历史保留；移动端保证基础浏览。
- Markdown 仓中文件可被上下文引擎读取并在对话中引用。

---

## 8. 上下文工程设计

### 8.1 ProjectContextService
- **输入来源**：
  1. 项目级高权重 Markdown（类似 Claude Project Instructions）。
  2. 画布快照（节点摘要、连线关系、最新 AI 生成物）。
  3. 选区上下文（所选节点内容、引用、卡片历史）。
  4. Skill 元数据（名称、触发条件、主要指令）。
  5. Display 容器摘要（仅在被引用或选中时加载，避免过载）。
- **上下文层级**：
  ```
  [层级 1] 项目固定指令/约束（必注入）
  [层级 2] 当前请求所需 Markdown 段落（按关键词召回）
  [层级 3] 白板快照（压缩后的节点结构）
  [层级 4] 选区或卡片上下文（最近 N 轮对话/节点内容）
  [层级 5] 容器草稿（底部对话栏生成但未确认时，仅在预览阶段加载）
  ```
- **Token 管理**：
  - 预估上下文 Token，如超阈值启动压缩策略（节点摘要、截断历史）。
  - 在响应中回传剩余预算提示（参照 Claude context awareness）。
  - 底部对话栏生成的草稿在确认前不写入白板，仅在上下文中以轻量摘要存在。

### 8.2 技能包（Skill）映射
- 结构参考 Claude Skills：`SKILL.md` 元数据 + 主指令 + 附件。
- 在项目中可启用多个技能，如“商科申请流程”“番茄学习板”。
- ProjectContextService 根据触发词或节点类型加载对应 Skill，并注入主指令/资源路径。

---

## 9. 多模型与多答案机制

- **模型注册**：复用 `src/lib/ai-clients.ts` 注册表（DeepSeek、Gemini、后续模型），通过环境变量控制启用。
- **能力元数据**：记录是否支持图像、工具、结构化输出，前端根据能力决定可选项。
- **交互策略**：底部对话栏在提交前提供模型与输出格式选择，可先生成草稿（不落盘），经用户确认后写入容器或卡片。
- **并行调用**：
  - 卡片中可选择多模型并行生成，前端横向排列结果，标注模型名称与耗时。
  - 结果需附带 `modelKey`、Token 使用、成功标记，用于 `recordAIUsage`。
- **降级策略**：若某模型缺少能力（如不支持图像），自动回退至默认模型并提示。
- **配额记录**：按模型键值写入使用日志，支持后续计费。

---

## 10. 分支管理与引用追溯

- **对话分支**：
  - 卡片节点默认继承所挂靠分支的上下文，内部记录多轮问答，每次生成对应子卡片或 Display 节点。
  - 分支树结构：`conversationId`、`parentId`、`branchLabel`，支持时间线视图。
  - 卡片与容器的关联通过 `linkedDisplayIds` 维护，容器可回溯到触发它的对话节点。
- **引用追溯（阶段 2 准备）**：
  - Display 节点允许保存 `citations` 数组，指向未来的文档索引。
  - 提前设计数据结构，便于阶段 1 末尾引入索引。

---

## 11. 前端视觉与交互规范

- **主题**：赛博朋克蓝紫主色（示例 #3B4DFF → #8B5CF6 渐变），搭配深色背景与低饱和对比层。
- **布局**：
  - 一级纵向主干使用半透明渐变背景，突出层级。
  - 二级节点采用卡片式设计，边缘抛光、轻微发光，连线使用柔光描边。
  - Display 容器具备标题栏、工具栏与缩放控件，选中时显示编辑态边框。
  - 卡片对话横向排列时保持 16px 网格，支持拖拽重新排列；底部对话栏固定在视窗底部，随容器类型展示不同占位提示。
- **动效**：节点生成/连线连接采用 200ms-300ms 缓动动画，突出 AI 生成的“跃迁感”。
- **组件体系**：沿用 Tailwind + Radix，设计统一的按钮、输入框、卡片状态，确保可维护。

---

## 12. 技术架构与数据模型

### 12.1 白板数据
```typescript
interface Board {
  id: string;
  userId: string;
  title: string;
  rootColumns: ColumnNode[]; // 一级纵向结构
  nodes: Node[];
  edges: Edge[];
  containers: ContainerNode[];
  conversations: ConversationNode[];
  contextSnapshots: ContextSnapshot[];
  createdAt: Date;
  updatedAt: Date;
}

interface ContainerNode {
  id: string;
  type: 'flowchart' | 'mindmap' | 'table' | 'timeline' | 'custom';
  data: DisplayPayload;
  position: { x: number; y: number };
  size: { width: number; height: number };
  zoom?: number;
  editable: boolean;
  parentColumnId: string;
  citations?: Citation[];
}

interface ConversationNode {
  id: string;
  parentId?: string;
  branchLabel?: string;
  inputs: ConversationMessage[];
  outputs: ConversationMessage[];
  modelResults?: ModelResult[];
  position: { x: number; y: number };
  linkedDisplayIds?: string[];
  references?: string[];
  branchContextId?: string; // 默认继承的分支/容器
}
```

### 12.2 Display Schema（示例）

`DisplayPayload` 统一描述容器内部结构，除业务字段外需附带 `meta.containerId`、`meta.editable`、`meta.draft` 等元信息，便于在确认草稿后写入白板。
```json
{
  "type": "mindmap",
  "root": {
    "title": "申请规划",
    "children": [
      { "title": "学术准备", "children": [...] },
      { "title": "实习经历" }
    ]
  },
  "meta": {
    "sourceModel": "deepseek-v3-1",
    "citations": [],
    "layoutHint": "hierarchy"
  }
}
```

### 12.3 API 契约
- `POST /api/ai/generate`：
  - 请求：`query`、`context`、`outputType`、`models`。
  - 响应（SSE）：`chunk`（文本）、`display`（结构化 JSON）、`complete`。
- `POST /api/project-context/summary`：
  - 用于生成项目级摘要，缓存 ProjectContextService 结果。

---

## 13. 阶段性路线图与指标

| 阶段 | 时间 | 目标 | 关键里程碑 | 核心指标 |
|------|------|------|------------|----------|
| 阶段 0（MVP） | 2-3 周 | 白板双入口 AI、思维导图、上下文选区、Markdown 仓 | 卡片对话上线、思维导图解析完成、底部对话栏原型、分支树可视化 | 生成时延 <5s、留存 >40%、场景案例展示 |
| 阶段 1 | 4-5 周 | 上下文工程完善、Display 扩展、Skill 插件 | ProjectContextService、结构化输出协议、底部统一入口正式上线、Skill 管理界面 | 上下文准确率 >85%、多类 Display 转化 |
| 阶段 2 | 4 周 | 引用追溯、自动布局、RAG 接入 | 文档索引服务、引用高亮、布局算法 | 引用命中率 >90%、布局满意度 |
| 阶段 3 | 6 周 | 协作化、生态化拓展 | 实时协作、共享模板、API 开放 | 团队活跃度、API 调用量 |

---

## 14. 风险与对策

| 风险 | 描述 | 对策 |
|------|------|------|
| 上下文过载 | Markdown + 画布 + 选区易超 Token | 引入摘要、分块加载、剩余预算提示 |
| 模型表现差异 | 多模型输出质量不一致 | 设定默认模型，提供模型说明与推荐场景 |
| 白板性能 | 大量节点/动画致性能下降 | 节流渲染、虚拟化列表、限制并发生成 |
| Skill 滥用 | 非预期技能触发造成偏差 | 设置触发关键字、提供可视化技能启停 |
| 用户学习成本 | 双入口交互复杂 | Onboarding 引导、模板示例、案例库 |
| 入口割裂 | 底部与侧栏体验不一致 | 阶段化统一方案，提供明确的输出格式选择与草稿确认流程 |

---

## 15. 附录

1. **调研摘要**：见《vilearning-项目探讨-251025.md》《vilearning-产品需求文档-251028.md》相关章节。
2. **Skill 文件模板**：
   ```markdown
   ---
   name: business-application
   description: Handle MBA application planning when user mentions留学/商科.
   ---
   # 商科申请规划 Skill
   ## 使用场景
   - 当用户需要规划商科研究生申请时启用
   ## 操作步骤
   1. 分析背景
   2. 提供季度任务
   3. 输出行动表格
   ```
3. **Display JSON 梳理表**：待阶段 1 输出。
4. **视觉参考**：参照 `/docs/前端引导/前端设计引导.md` 与《实用指南：提升视觉设计》。

---

> 备注：后续迭代完成后，请同步更新本文件并调用 Serena `write_memory` 记录关键决策（当前环境暂不可用）。
