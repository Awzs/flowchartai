# ViLearning 空间化学习平台产品需求文档（2025-11-01）

> 文档属性：Product Requirement Document  
> 覆盖范围：产品、设计、前端、后端、AI、运营团队  
> 版本说明：基于 2025-10-30 版本与 2025-11-01 补充决策重新梳理，聚焦“流程图链路加固 → 多 Display 白板底座 → 新 Display 模块分阶段落地”路线。

---

## 1. 产品概述与愿景

- **愿景**：打造面向知识工作者的空间化学习与创作工作台，让白板成为结构化内容的中枢，并通过模块化 AI 生成能力持续扩展。
- **核心定位**：先让流程图链路可靠、性能稳定，再构建可扩展的多 Display 白板底座，随后以“一个 Display 一个阶段”的方式迭代思维导图、测验等能力。
- **关键原则**：
  1. **兼容优先**：阶段 0 不改动既有数据结构，新增能力以向后兼容方式落地。
  2. **模块化演进**：白板底座与 AI 生成链路要支持按 Display 类型配置与扩展。
  3. **性能优先**：流程图链路需先达标响应时间与稳定性，再叠加新 Display。
  4. **提示词内置管理**：所有 Display Prompt 模板以 TS 配置集中管理，可追溯、可灰度。

---

## 2. 当前能力与关键痛点

- **既有能力**：
  - AI 生成流程图：`/api/ai/chat/flowchart` 路由串联提示词+工具调用，前端侧栏可流式呈现（源自 `src/components/canvas/ai-chat-sidebar.tsx`）。
  - 白板：基于 Excalidraw，流程图以 Mermaid → Excalidraw JSON 渲染，支持导出 PNG/SVG/JSON。
  - 数据：`flowcharts` 表存储纯 Excalidraw JSON，与用户绑定，尚无 Display 类型区分。
  - AI 用量治理：`ai_usage` 表记录调用，具备限流与访客策略。
- **主要痛点**：
  - 仅有流程图表示，尚无多 Display 容器；白板无法直接承载思维导图/测验。
  - 提示词写死在流程图路由，无法按 Display 切换，缺乏配置化管理。
  - 结构化生成失败降级机制简单，不能自动重试并保留文本草稿。
  - 节点选区上下文只具备基础准备，缺乏节点级数据抽取与 Token 控制策略。
  - 白板性能在复杂流程图时存在卡顿，未来引入更多 Display 会放大问题。

---

## 3. 约束与设计原则

- **阶段 0** 聚焦流程图链路的性能、稳定性与上下文闭环；不引入思维导图、测验的完整编辑。
- **白板多格式底座** 必须先落地，再逐一上线新 Display（思维导图、测验等）。
- **组件选型优先复用成熟生态**：思维导图、测验优先评估成熟 SDK/开源库，除非无法满足核心需求才自研。
- **数据结构兼容**：在引入 Display 类型前不做破坏性迁移；新增字段需默认值、回填策略。
- **上下文选区**：阶段 0 仅支持 Excalidraw 节点（流程图），其它 Display 在对应阶段补齐。
- **降级策略**：结构化生成失败时最多自动重试 3 次，仍失败则返回文本草稿于侧栏，保留错误原因。
- **测验导出**：非阶段 0/1 重点，排期到测验模块稳定后再落实（预计阶段 3+）。
- **Prompt 管理**：建立 TS 配置（如 `display-prompts.ts`），集中维护 Display 类型、系统提示与重试策略。

---

## 4. 阶段目标概览

| 阶段 | 时间窗口（预估） | 核心目标 | 主要交付物 | 成功指标 |
|------|-----------------|----------|------------|----------|
| 阶段 0：流程图链路加固 | 当前 ~ 3 周 | 提升流程图生成稳定性、性能与上下文闭环 | AI 重试机制、选区上下文（流程图）、性能优化报告、Prompt 配置化 | 成功率 ≥92%；平均首响应 <2.5s；重试失败转文本成功率 100% |
| 阶段 1：多 Display 白板底座 | 3 ~ 6 周 | 完成 Display 注册表、白板容器抽象、数据结构扩展（兼容模式） | DisplayRegistry、白板容器抽象层、`flowcharts` 扩展字段（默认值兼容）、草稿面板技术预研 | 核心链路无回归；新增字段不影响旧数据读取；底座性能通过压力测试 |
| 阶段 2：思维导图模块 | 6 ~ 9 周 | 选型成熟思维导图库，完成生成→呈现→基础交互闭环 | 库选型评估、思维导图 Schema、服务端校验、白板只读/基础编辑组件 | 结构化成功率 ≥85%；渲染性能稳定；用户可写入/读取思维导图 |
| 阶段 3：测验模块 | 9 ~ 12 周 | 定义测验 Schema，落地生成与白板呈现，导出列入后续版本 | 测验生成接口、白板卡片容器、答题/标注交互、失败降级策略 | 结构化成功率 ≥85%；白板加载耗时 <300ms；文本降级清晰可读 |
| 阶段 4：上下文工程与生态 | 12 周以后 | 项目级上下文、分支管理、Skill/模型扩展 | ProjectContextService、分支追溯、Skill 插件框架、多模型接口 | 上下文命中率 ≥70%；分支追溯稳定；Skill 需求评审通过 |

---

## 5. 阶段任务详情

### 5.1 阶段 0：流程图链路加固
- **目标**：确保现有流程图体验可靠、性能可控，为后续多 Display 能力奠定基础。
- **任务拆解**：
  - **AI 调用稳定性**：实现结构化失败自动重试（最多 3 次），记录重试日志，最终失败时在侧栏输出文本草稿与错误提示。
  - **Prompt 配置化**：将流程图系统提示迁移到 Display Prompt 配置文件，支持按 Display 加载、灰度切换。
  - **选区上下文（流程图）**：建立节点 ID、文本、连接关系的抽取逻辑，并在请求中按优先级拼接（选区 > 最新 AI 输出 > 用户消息）。
  - **性能优化**：分析 Excalidraw 渲染瓶颈，重点解决大图加载耗时与多节点操作时的卡顿，形成优化报告与验证指标。
  - **监控与指标**：补充结构化输出日志字段（重试次数、失败原因），Dashboard 监控成功率。
- **验收条件**：
  - 正常流程图生成成功率 ≥92%，重试后降级文本须提示“已回退为文本草稿”。
  - 桌面端加载 200 节点流程图首屏 <2.5s，节点拖拽平均帧率 ≥55fps。

### 5.2 阶段 1：多 Display 白板底座
- **目标**：在不破坏现有流程图数据的前提下，搭建可承载多 Display 的白板基础设施。
- **任务拆解**：
  - **DisplayRegistry**：抽象 Display 类型配置（Schema 校验器、PromptKey、渲染组件、导出策略）。
  - **白板容器分层**：将 Excalidraw 包裹在统一的 DisplayHost 中，预留思维导图、测验等容器挂载入口。
  - **数据层扩展**：为 `flowcharts` 表新增 `display_type`、`structured_payload`、`ai_snapshot` 等字段，默认值保障旧数据兼容；更新 API 读写逻辑但不迁移历史数据。
  - **接口统一**：设计 `/api/ai/display` 路由接口规范，实现流程图兼容调用。
  - **草稿面板预研**：输出技术方案（状态管理、存储方式、性能评估），阶段内不落地 UI。
- **验收条件**：
  - 流程图链路在新底座上运行稳定，无回归。
  - DisplayRegistry 能够动态注册/禁用 Display，单元测试覆盖基础配置。
  - 新增字段默认值验证通过，老数据读取、保存不报错。

### 5.3 阶段 2：思维导图模块
- **目标**：引入成熟库完成思维导图生成与白板呈现，提供基础浏览与编辑。
- **任务拆解**：
  - **库选型**：对比 `mind-elixir`, `@antv/x6-mind`, `reactflow + mindmap 扩展`，评估渲染性能、编辑能力、授权条款，输出决策记录。
  - **Schema 设计**：定义 `type/root/children/meta` 等字段的 JSON Schema，涵盖节点排序、标记、折叠信息。
  - **服务端校验**：新增思维导图生成器，复用自动重试机制，校验 JSON 结构与节点数阈值。
  - **白板组件**：封装思维导图容器，支持只读渲染 + 基础节点编辑（文本修改、节点增删、折叠），并与 DisplayRegistry 集成。
  - **上下文同步**：生成后将摘要写入 `structured_payload`，选区上下文暂时仅读取根节点信息（深度扩展待阶段 4）。
- **验收条件**：
  - 思维导图生成成功率 ≥85%，节点上限默认 120 个。
  - 白板加载思维导图 <400ms，基础编辑操作延迟 <150ms。
  - 失败降级文本明确标注“思维导图生成失败，已返回文本草稿”。

### 5.4 阶段 3：测验模块
- **目标**：完成测验/任务结构生成、白板呈现与基础交互，导出能力留待后续。
- **任务拆解**：
  - **Schema 设计**：题目、选项、答案/提示、标签、难度等字段定义。
  - **Prompt 与校验**：测验模板 Prompt 配置化，服务端校验题干/选项完整度与题量阈值。
  - **白板组件**：以卡片列表方式呈现，支持答题状态（未答/已答）、标签筛选等轻量交互。
  - **降级策略**：沿用自动重试 + 文本草稿，强调错误提示。
  - **导出规划**：形成 Markdown/CSV 导出需求草案，但不在阶段 3 交付。
- **验收条件**：
  - 成功率 ≥85%，生成 10 题以内响应 <5s。
  - 白板卡片渲染耗时 <300ms，操作无明显卡顿。

### 5.5 阶段 4：上下文工程与生态
- **目标**：在核心 Display 稳定后，引入项目级上下文、分支管理与 Skill 生态。
- **关键任务**：
  - ProjectContextService：整合项目说明、白板快照、历史生成物，提供分层抽取与 Token 控制。
  - 分支管理：记录 Display 迭代历史与对话分支，支持时间线追溯。
  - Skill 插件：以配置化方式加载行业模板，提供启停开关。
  - 多模型扩展：保留并行模型接口，但暂不启用，确保后续易扩展。

---

## 6. 技术实现要点

- **AI 生成链路**：
  - 统一 `/api/ai/display` 接口，基于 DisplayRegistry 分派 Schema 校验、Prompt、工具调用。
  - 重试机制须记录尝试次数、响应耗时，落库以便后续调优。
  - 侧栏需支持不同 Display 的上下文摘要展示，失败时以文本卡片形式回写。
- **白板架构**：
  - 引入 DisplayHost（负责挂载具体组件、同步 `structured_payload`），拆分共享工具栏、导出能力。
  - 为未来多 Display 并存准备布局管理（栅格/定位策略），阶段 1 输出设计稿。
- **性能治理**：
  - 建立压测脚本，覆盖流程图复杂场景与后续思维导图节点密集场景。
  - 优化 Excalidraw 状态同步，确保选区上下文采集不会频繁触发重渲染。
- **选区上下文**：
  - 阶段 0 构建流程图节点摘要器（ID、文本、关联边），并限制 Token 使用。
  - 后续 Display 通过 DisplayRegistry 注册上下文提取器，逐步扩展。

---

## 7. 数据与兼容策略

- **表结构扩展**：为 `flowcharts` 表新增字段但设默认值，避免历史数据迁移。
- **结构化缓存**：`structured_payload` 用于存储原始 AI JSON，前端渲染缓存使用 `ai_snapshot`。
- **版本字段**：新增 `schema_version` 以标记不同 Display/模板版本，便于后续迁移。
- **审核流程**：任何即将破坏兼容性的变更需列入阶段 4 以后，由架构评审确认。

---

## 8. 提示词与模型管理

- 建立 `src/lib/prompts/display-prompts.ts`（示例路径），存放 Display → Prompt 模板、重试策略、模型选择。
- Prompt 模板需包含：结构化说明、禁止符号、失败兜底指引。
- 支持按环境变量切换默认模型，且记录每次调用使用的模型、Prompt 版本。
- 为阶段 4 的 Skill 扩展预留合并逻辑，使 Skill 可覆盖默认 Prompt。

---

## 9. 风险与对策

| 风险 | 描述 | 应对策略 |
|------|------|----------|
| 重试导致延迟上升 | 最多三次重试可能拉长响应 | 统计平均耗时，必要时调整重试间隔或默认重试次数；允许用户中断 |
| 白板底座改造引发回归 | 底座抽象可能影响现有流程图体验 | 编写回归测试、建立测试用流程图样本库，阶段 1 灰度发布 |
| 第三方思维导图库受限 | SDK 授权或性能不符合预期 | 在阶段 2 前完成选型 PoC，准备备选库或降级方案 |
| 数据结构扩展遗漏兼容 | 新增字段未覆盖特定 API | 设计自动化测试覆盖读写、导出、历史数据加载 |
| 侧栏文本降级体验差 | 用户不理解降级原因 | 降级消息需提示重试次数与失败原因，提供“复制文本至白板”入口 |

---

## 10. 待确认事项

1. DisplayRegistry 与 Prompt 配置文件的最终存放路径、命名约定是否有团队预期？
2. 白板草稿面板技术预研完成后是否需要在阶段 1 末评审一次，决定是否提前落地？
3. 思维导图库 PoC 是否需要覆盖移动端手势操作场景？
4. 测验模块的题型范围（仅单选/多选/判断，是否包含简答题）需在阶段 3 前确定。
5. 阶段 4 的 ProjectContextService 与 Skill 插件是否需要与外部系统对接（如企业知识库）？需提前列出接口需求。

---

## 11. 验收与测评建议

- **自动化测试**：每新增 Display 都需提供 Schema 校验单测与端到端生成回放用例。
- **性能压测**：流程图阶段压测 200 节点；思维导图阶段压测 150 节点、5 层级；测验阶段压测 20 题列表。
- **人工验收脚本**：为每个 Display 准备 2 套 Demo 场景（包含失败重试），确保文案与降级一致。
- **数据看板**：建立成功率、平均耗时、重试次数、降级次数等核心指标监控。

---

本版本聚焦“流程图链路加固 + 多 Display 底座 + 新 Display 模块逐级迭代”的策略，确保在兼容既有用户数据的前提下，实现可持续扩展的产品演进路线。🎯

