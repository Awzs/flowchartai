# ViLearning 空间化学习平台产品需求文档（2025-10-30）

> 文档属性：Product Requirement Document
> 面向对象：产品、设计、前端、后端、AI、运营团队
> 版本说明：基于 2025-10-25 / 10-28 / 10-29 输出，并结合 2025-10-30 对核心能力的重新定位完成梳理。

---

## 1. 产品概述与愿景

- **愿景**：打造面向知识工作者的空间化学习与创作工作台，让碎片信息被 AI 转换成可编辑、可追问的结构化知识网络。
- **核心定位**：白板 + AI 结构化输出，围绕流程图、思维导图、测验三种结构化形态，形成“生成 → 呈现 → 深挖”的闭环体验。
- **关键原则**：
  1. **结构化优先**：任何新增能力均需首先落实结构化生成与白板呈现。
  2. **上下文增强**：以白板选区和系统提示词驱动 AI，逐步完善上下文工程。
  3. **阶段化推进**：先交付三大核心能力，再引入卡片对话、分支管理、Skill 等增强功能。

---

## 2. 阶段目标总览

| 阶段 | 时间窗口（预估） | 核心目标 | 主要交付 | 成功指标 |
|------|-----------------|----------|----------|----------|
| 阶段 0（核心闭环） | 立即 ~ 3 周 | 落地三大核心功能 | 侧栏结构化生成 + 白板呈现编辑 + 选区上下文追问 | 结构化输出成功率 ≥85%；选区上下文命中率 ≥70% |
| 阶段 1（白板深化） | 3 ~ 6 周 | 扩充结构化类型与交互 | 测验/任务板等结构化模板、底部草稿面板、导出能力完善 | Display 类型 ≥4；编辑/导出成功率 ≥90% |
| 阶段 2（上下文工程） | 6 ~ 10 周 | 完善项目级上下文与分支体系 | ProjectContextService、分支管理、卡片对话 | 上下文调度稳定；分支追溯可用 |
| 阶段 3（生态拓展） | 10 周以后 | Skill 体系与多模型生态 | Skill 插件、并行模型、引用追溯 | Skill 需求评审通过；并行调用实验成功 |

> 阶段划分以三大核心能力为中心展开：阶段 0 保证 MVP 闭环；阶段 1 深化白板体验；阶段 2 才引入上下文工程与分支；阶段 3 再推进生态能力。

---

## 3. 核心用户流程

### 3.1 从生成到呈现的闭环

1. 用户在侧栏输入任务（可选场景：商科留学规划、ADHD 日程安排、课程梳理）。
2. 系统根据场景加载系统提示词与结构化模板，调用 LLM 生成目标 Display（流程图/思维导图/测验）。
3. 白板即时渲染生成的结构化内容，用户可直接拖拽、编辑、保存或导出。

### 3.2 选区追问与上下文复用

1. 用户在白板框选或点选节点，侧栏自动读取选区数据、最近生成的 Display 元信息等上下文。
2. 用户在侧栏继续提问，AI 将选区上下文与系统提示词合并，再次生成结构化或侧栏中的文本对话回复。
3. 生成内容可写入 Whiteboard 或保留为草稿，形成循环深化的知识网络。

---

## 4. 三大核心功能需求

### 4.1 核心功能一：结构化内容生成

- **目标**：AI 根据侧栏输入 + 系统提示词生成结构化输出，覆盖流程图、思维导图、测验三类 Display。
- **功能范围**：
  - 系统提示词模板化管理：按 Display 类型加载不同 Prompt，确保结构化输出稳定。
  - 流程图：沿用现有 `generate_flowchart` 工具，继续输出 Mermaid 并校验格式。
  - 思维导图：定义 JSON Schema（`type`/`root`/`children`/`meta`），支持层级、排序与节点标注。
  - 测验/任务：定义题目列表或任务板 Schema，包含题干、选项、答案/标签等字段。
  - 验证与降级：
    - 服务端校验结构化 JSON，失败时返回文本草稿并提示用户手动修正。
    - 记录结构化输出日志，便于后续调优。
- **验收指标**：
  - 结构化输出成功率 ≥85%（按调用次数统计）。
  - 每类 Display 至少具备 2 个可演示案例。
  - 失败时提供可读文本或明确错误提示。

### 4.2 核心功能二：白板呈现、编辑与导出

- **目标**：用户在白板上查看、编辑、导出结构化内容，保持与 AI 生成结果同步。
- **功能范围**：
  - 白板渲染：
    - 流程图继续依赖 Excalidraw + Mermaid 转换。
    - 思维导图引入独立组件（Tree/Mindmap library），支持节点折叠、拖拽、文本编辑、颜色标签。
    - 测验/任务使用卡片列表或表格形式呈现，支持勾选/标注。
  - 编辑能力：
    - 支持手动修改节点文本、增加/删除节点、调整布局。
    - 修改后同步更新数据模型，确保再次生成时可引用最新内容。
  - 导出功能：
    - 流程图导出 PNG/SVG/JSON，沿用现有能力并补充导出提示。
    - 思维导图导出为 JSON / Markdown 结构文本。
    - 测验/任务导出为 Markdown 或 CSV。
  - 存储与版本：
    - MVP 继续使用 `flowcharts` 表存储 Excalidraw JSON，阶段 1 后根据 Display 类型调整存储结构。
    - 记录最近一次 AI 生成时间与来源模型，便于追溯。
- **验收指标**：
  - 白板编辑操作延迟 ≤200ms；导出成功率 ≥90%。
  - 用户手动修改后保存并重新载入仍保持一致。
  - 思维导图与测验在白板中呈现无重大视觉或交互缺陷。

### 4.3 核心功能三：上下文选取与侧栏追问

- **目标**：允许用户在白板选取内容，侧栏自动携带上下文再次调用 AI，完成深度追问。
- **功能范围**：
  - 选区上下文采集：
    - 支持框选、点选或多选节点，提取节点文本、类型、元信息。
    - 结构化内容需生成可用于上下文的摘要或引用 ID。
  - Prompt 组装：
    - 侧栏请求包含用户输入 + 系统提示词 + 选区上下文 + 最近一次结构化输出摘要。
    - 控制 token 不超过 1500，超限时优先保留选区摘要与最新结构化内容。
  - 交互反馈：
    - 在侧栏显示已注入的上下文摘要，用户可手动剔除不需要的部分。
    - 若无选区，则仅基于系统提示词与用户输入生成结果。
  - 输出处理：
    - 支持直接生成新的结构化内容或普通文本卡片。
    - 提供“写入白板”“仅保存草稿”“丢弃”三种操作。
- **验收指标**：
  - 选区上下文命中率 ≥70%（AI 回复中实际引用选区内容）。
  - 上下文预览清晰，用户能理解本次 AI 请求包含哪些信息。
  - 无选区情况下表现与现有流程图助手一致。

---

## 5. 阶段化需求拆解

### 5.1 阶段 0（核心闭环）

- **目标**：交付流程图 + 思维导图 + 测验三类结构化生成、白板呈现编辑、选区上下文追问的最小可用版本。
- **关键任务**：
  1. 更新侧栏交互：支持选择 Display 类型，加载对应系统提示词。
  2. 完成思维导图与测验的 Schema 设计、AI 提示词与服务端校验。
  3. 白板接入思维导图、测验组件，提供基础编辑与导出。
  4. 实现选区上下文采集与 Prompt 拼装，确保侧栏可追问。
  5. 撰写三类结构化输出的测试用例与人工验收流程。
- **验收节点**：
  - 在真实场景中完成“生成 → 修改 → 选区追问”的全链路演示。
  - 每个 Display 形成至少两个典型案例。

### 5.2 阶段 1（白板深化）

- **扩展点**：
  - 结构化模板扩展：新增任务板、复盘模板、行动清单等。
  - 草稿管理：引入底部草稿面板，允许多轮生成对比后再写入白板。
  - 导出能力完善：统一导出入口，支持批量导出与格式选择。
  - 多语种支持与可访问性改进。

### 5.3 阶段 2（上下文工程）

- **新增模块**：
  - ProjectContextService：整合项目说明、白板快照、分支上下文，提供多级上下文抽取与压缩。
  - 分支管理：记录对话分支、Display 来源，支持时间线回溯。
  - 卡片对话：在白板卡片内直接继续对话，继承上下文。

### 5.4 阶段 3（生态拓展）

- **规划方向**：
  - Skill 插件：定义 `SKILL.md` 元数据，按项目启停专业模板。
  - 并行模型：支持多模型同时返回结果，侧栏对比展示。
  - 引用追溯：在结构化输出中标注来源，支持导出。
  - 协同功能：多人实时编辑、共享模板、开放 API。

---

## 6. 技术与数据影响

- **前端**：
  - 侧栏需支持多 Display 类型选择、上下文预览、草稿管理。
  - 白板组件需容纳 Excalidraw + Mindmap + 表格/列表等，多组件共存管理状态。
  - 思维导图与测验组件需具备可编辑性与导出能力，建议封装为独立模块。
- **后端**：
  - AI 路由需要区分不同 Display 类型，返回结构化 JSON 并校验。
  - 阶段 0 可在现有 `flowcharts` 表基础上扩展字段；阶段 2 规划 `boards`/`containers` 数据模型与迁移脚本。
  - 上下文服务需提供选区摘要与 token 控制策略。
- **提示词与模型管理**：
  - 维护 Display 类型与系统提示词的映射。
  - 监控结构化输出质量，调整 Prompt。
  - 保留模型切换接口，为阶段 3 的并行模型做准备。

---

## 7. 风险与对策

| 风险 | 描述 | 对策 |
|------|------|------|
| 结构化输出不稳定 | 模型返回的 JSON 不符合预期 Schema | 加强服务端校验与降级方案；记录模型日志用于优化 |
| 白板性能压力 | 多种组件共存、节点复杂度提升 | 引入虚拟化策略、限制一次生成节点数量、优化渲染管线 |
| 上下文超限 | 选区 + 系统提示词易超 Token | 设定优先级顺序，阶段 2 引入 ProjectContextService 做压缩 |
| 编辑与 AI 同步困难 | 用户手动修改与 AI 生成的内容可能脱节 | 保存节点元信息，生成时提示“根据最新节点调整”选项 |
| 模板维护成本 | 多类型 Display 需要持续维护 Prompt | 采用配置化方式管理模板，定期校准示例 |

---

## 8. 待确认与后续决策

1. 思维导图与测验组件选型（开源库 vs. 自研）及定制化程度。
2. 阶段 0 是否需要对历史流程图数据进行迁移或保持兼容。
3. 结构化输出中是否需要立即引入引用标注，或阶段 3 再落实。
4. 底部草稿面板的推出时机（阶段 0-1 之间还是直接进入阶段 1）。
5. 上下文预览的详细交互：是否允许用户重排序或强制删除部分上下文。
6. 测验/任务 Display 的导出格式优先级（Markdown、CSV、PDF 等）。

---

## 9. 附录

- 调研资料：见《vilearning-项目探讨-251025.md》《vilearning-产品需求文档-251028.md》。
- 模型接入：参考 `/docs/API调用引导` 中的火山引擎 DeepSeek 文档。
- 视觉规范：参照 `/docs/前端引导/前端设计引导.md`。
- 历史版本：旧稿见 `vilearning-产品需求文档-251030-旧-过于激进.md`，仅作参考。

---
