# 数据迁移草案（boards / displays / contexts）

## 1. 背景
为支撑多 Display 架构与上下文工程，需要将现有 `flowcharts` 表拆解为 `boards` / `displays` / `contexts` 三张表，并提供灰度迁移、回滚能力。本草案给出表结构设计与脚本雏形。

## 2. 目标结构
```sql
-- boards：白板/项目级信息
CREATE TABLE boards (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,
  title VARCHAR(255),
  description TEXT,
  display_type VARCHAR(50) DEFAULT 'flowchart',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- displays：具体 Display 单元（流程图、思维导图等）
CREATE TABLE displays (
  id UUID PRIMARY KEY,
  board_id UUID NOT NULL REFERENCES boards(id) ON DELETE CASCADE,
  display_type VARCHAR(50) NOT NULL,
  title VARCHAR(255),
  excalidraw_data JSONB,
  structured_payload JSONB,
  ai_snapshot JSONB,
  ai_model TEXT,
  prompt_version TEXT,
  tokens_used INTEGER,
  position_x INTEGER DEFAULT 0,
  position_y INTEGER DEFAULT 0,
  width INTEGER DEFAULT 800,
  height INTEGER DEFAULT 600,
  scale NUMERIC(8,4) DEFAULT 1,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- contexts：上下文缓存
CREATE TABLE contexts (
  id UUID PRIMARY KEY,
  board_id UUID NOT NULL REFERENCES boards(id) ON DELETE CASCADE,
  context_type VARCHAR(50) NOT NULL,
  context_value JSONB NOT NULL,
  token_count INTEGER DEFAULT 0,
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## 3. 迁移阶段
1. **Phase 1：创建新表**
   - 执行上述建表语句。
   - 配置触发器或应用层双写逻辑（新写入同时写 flowcharts + displays）。
2. **Phase 2：数据迁移**
   - 从 `flowcharts` 中读取旧数据，批量写入 `boards`/`displays`。
   - 思维导图上线前可将 `display_type` 写为 `flowchart`，MindMap 保存链路完成后按 DisplayType 区分。
3. **Phase 3：灰度切换**
   - API 逐步改为读取新表；监控错误率。
   - 无异常后停用旧表写入，准备回滚脚本。

## 4. 脚本雏形
- 新增 `scripts/migrations/draft-boards-displays.ts`：默认 dry-run，输出建表与迁移 SQL，可通过 `--execute` 开关预留真连库逻辑。
- 运行示例：
  ```bash
  pnpm tsx scripts/migrations/draft-boards-displays.ts --dry-run
  ```
  终端可见 SQL 预览及执行计划摘要。

## 5. Dry-Run 验证
- 2025-11-02：本地执行 dry-run，脚本成功输出建表及迁移 SQL，无语法错误。
- 需在接入真实数据库前补充连接配置，并根据环境变量控制执行。

## 6. 后续事项
- 与后端团队确认 UUID 生成策略与历史数据兼容性。
- 为迁移脚本补充自动化测试（模拟内存数据库）。
- 制定回滚脚本：将 `displays` 数据写回旧表或恢复备份。
