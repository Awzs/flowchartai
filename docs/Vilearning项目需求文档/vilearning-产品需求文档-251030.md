# ViLearning 空间化学习平台产品需求文档（2025-10-30）

> 文档属性：Product Requirement Document  
> 面向对象：产品、设计、前端、后端、AI、运营团队  
> 版本说明：基于 2025-10-25 / 10-28 / 10-29 输出，并结合 2025-10-30 讨论结论重排阶段目标与需求边界。

---

## 1. 产品概述与愿景

- **愿景**：面向知识工作者的空间化学习与创作工作台，让碎片资料被 AI 自动组织成可视化知识网络并持续迭代。
- **核心定位**：白板 + AI 结构化输出的组合，先以商科留学规划与 ADHD 多线程学习为示范案例，再逐步拓展到通用知识工作者。
- **关键原则**：
  - 聚焦阶段化可交付，避免一次性堆叠所有概念。
  - 所有新增功能需可追溯、可验证，保证研发按阶段推进。
  - 默认模型维持 DeepSeek V3.1（火山引擎），保留扩展接口。

---

## 2. 阶段目标总览

| 阶段 | 时间窗口（预估） | 核心目标 | 主要交付 | 成功指标 |
|------|-----------------|----------|----------|----------|
| 阶段 0（MVP） | 立即 ~ 2 周 | 夯实现有流程图助手闭环 | 侧栏 AI + Mermaid + Excalidraw 保存 | 3 个真实案例落地；生成成功率 ≥90% |
| 阶段 1（增强版） | 2 ~ 5 周 | 引入项目上下文与思维导图 | Markdown 项目说明、底部对话栏、独立思维导图组件 | 思维导图生成成功率 ≥80%；上下文命中率 ≥70% |
| 阶段 2（结构化升级） | 5 ~ 9 周 | 完善上下文工程与数据结构 | Board/Container 数据模型、Display 类型扩展、分支管理规划 | 数据迁移方案评审通过；Display 类型 ≥3 |
| 阶段 3（生态拓展） | 9 周以后 | 技能化与生态能力 | Skill 插件体系、多模型并行、引用追溯 | Skill 需求评估完成；并行调用实验验证成功 |

---

## 3. 核心用户场景

### 3.1 商科留学规划（展示案例）

1. 用户登录 → 打开流程图画布 → 在侧栏描述“申请阶段流程”。
2. AI 产出流程图草稿，用户校对后写入并保存为案例节点。
3. 在阶段 1 后，可追加项目说明文档与思维导图，为后续复盘提供结构化材料。

### 3.2 ADHD 多线程学习（展示案例）

1. 用户创建“每日节奏”项目，MVP 阶段使用流程图拆解任务流。
2. 阶段 1 后，用户可在底部对话栏生成思维导图/任务表，对比不同节奏安排。
3. 阶段 2 引入分支与引用追溯，帮助用户记录不同策略的效果。

---

## 4. 阶段化需求详解

### 4.1 阶段 0（MVP）

- **目标**：确保现有流程图 AI 助手稳定可用，形成可演示资产。
- **功能范围**：
  - 侧栏 AI 对话生成流程图（文字/图像双模式，沿用 `generate_flowchart` 工具）。
  - Mermaid → Excalidraw 转换与落盘，保存至 `flowcharts` 表（`src/app/api/ai/chat/flowchart/route.ts:12`）。
  - 模型配置抽象（`src/lib/ai-clients.ts:31`），默认 DeepSeek。
  - 日志与配额沿用现有 `ai-usage` 模块。
- **排除项**：
  - 用户自定义项目说明。
  - 底部对话栏、思维导图、Skill、分支管理。
- **验收标准**：
  - 登录用户可从输入到保存完成全流程，无关键报错。
  - 生成的流程图在 Excalidraw 中可编辑、重保存。
  - 形成不少于 3 个典型流程图案例。

### 4.2 阶段 1（增强版）

- **目标**：在不破坏现有数据库的前提下，提供更丰富的上下文与结构化输出。
- **新增能力**：
  1. **项目上下文（轻量版 ProjectContextService）**  
     - 单项目可上传/编辑一份 Markdown 说明（高优先级片段 + 指令）。  
     - 请求时仅拼接项目说明 + 最近一次 AI 输出摘要，不引入多层压缩。  
     - 不改现有 `flowcharts` 表，说明文档暂存独立表或对象存储。
  2. **独立思维导图组件**  
     - 底部对话栏触发“生成思维导图”，AI 返回受控 JSON（`type`/`root`/`children`/`meta`）。  
     - 前端使用独立的树形可视化组件（非 Excalidraw Mermaid），支持折叠、编辑标题、拖拽排序。  
     - 草稿先在草稿面板预览，确认后写入存储。
  3. **底部对话栏（全局固定）**  
     - 白板底部固定对话栏，支持模式切换（普通回复/思维导图/后续扩展）。  
     - 草稿预览面板展示 AI 生成内容，用户确认后落盘。  
     - 流程图请求继续走侧栏，底部对话栏暂不兼容流程图模式。
- **验收标准**：
  - 思维导图生成成功率 ≥80%，返回 JSON 可被渲染或提供友好降级提示。
  - 项目说明成功注入上下文并影响 AI 响应（需提供测试提示与日志）。
  - 底部对话栏操作路径清晰，草稿确认后再写入，无重复落盘。

### 4.3 阶段 2（结构化升级）

- **目标**：为后续生态扩展打基础，统一数据结构与上下文管线。
- **重点事项**：
  1. **Boards/Containers 数据模型**  
     - 将现有 `flowcharts` 升级为 `boards`（项目级）+ `containers`（Display 节点）。  
     - 规划数据迁移脚本，保证历史流程图可迁移或无缝导入。  
     - 前端兼容旧数据读取逻辑直至迁移完成。
  2. **上下文工程 2.0**  
     - 引入选区上下文、节点摘要、Token 管理与缓存策略。  
     - 提供上下文调试面板，显示实际注入内容与长度。
  3. **Display 类型扩展**  
     - 在思维导图基础上新增表格/时间线容器，统一 Schema。  
     - 草稿确认流程复用阶段 1 底部对话栏。
  4. **分支管理与引用追溯（设计稿与后端模型）**  
     - 设计 `conversation_sessions`、`citations` 等表结构。  
     - 初期可只输出设计与原型，视资源决定是否在本阶段落地。
- **验收标准**：
  - 数据迁移方案评审通过，并完成至少一次演练。  
  - Display 类型数量 ≥3，并提供最小渲染与编辑能力。  
  - 上下文调试面板可用于 QA 验证。

### 4.4 阶段 3（生态拓展）

- **目标**：在基础能力稳定后探索技能化与生态接口。
- **规划方向**：
  - Skill 插件体系（参照 Claude Skills），支持项目级启停与指令注入。  
  - 多模型并行生成（前端展示对比、记录 token）。  
  - 引用追溯与审计（标注来源、支持导出）。  
  - 协同/分享/API 视资源排期逐步推进。
- **前置条件**：阶段 2 的 Board/Container 模型与上下文工程已稳定。

---

## 5. 技术与数据影响

### 5.1 现有架构快照

- 前端：Next.js 15 + Tailwind + Radix，白板基于 Excalidraw 单画布（`src/components/canvas`）。
- 后端：Next.js API Route + Drizzle ORM，核心表为 `flowcharts`（`src/db/migrations/0002_zippy_oracle.sql:1`）。
- AI：OpenAI 兼容 SDK，模型注册于 `src/lib/ai-clients.ts:31`，侧栏路由为 `src/app/api/ai/chat/flowchart/route.ts:12`。

### 5.2 阶段性调整摘要

- **阶段 0**：以稳定性为核心，仅补充监控与测试脚本（可选）。
- **阶段 1**：
  - 新增 Markdown 存储（可使用 `project_briefs` 表）与思维导图存储。  
  - 底部对话栏需要新的前端状态管理（建议沿用 Zustand/TanStack Query）。  
  - AI 接口可复用现有客户端，增加 `outputType` 参数与 JSON 校验。
- **阶段 2**：
  - 推出通用数据模型与迁移脚本。  
  - 上下文服务抽象为独立模块（可放置于 `src/lib/context`）。  
  - 引入缓存及限流策略，避免 Token 过载。
- **阶段 3**：
  - Skill 元数据管理、并行调用调度、审计日志与导出接口。

---

## 6. 用户操作流程（更新版）

### 6.1 流程图生成（阶段 0）

1. 用户在侧栏输入需求或上传流程图图片。  
2. 服务端根据当前模型生成 Mermaid → 转换为 Excalidraw 元素。  
3. 用户确认后写入画布，可编辑、保存或导出。

### 6.2 思维导图生成（阶段 1）

1. 用户在底部对话栏选择“思维导图”，可附加项目说明或选区信息。  
2. 服务端返回结构化 JSON，草稿面板展示节点树。  
3. 用户确认 → 写入思维导图容器，可在独立组件内调整排版。

### 6.3 项目上下文注入（阶段 1）

1. 用户在项目设置页上传 Markdown 说明（含语气、输出要求）。  
2. 请求 AI 时，后端拼接说明 + 最近一次 AI 输出摘要。  
3. 返回响应中标记 `contextSources`，便于排查。

---

## 7. 验收与度量

- **阶段 0**：流程图生成成功率 ≥90%；用户可保存并再次打开；成功案例 ≥3。
- **阶段 1**：思维导图成功率 ≥80%；上下文命中率 ≥70%；底部对话栏满意度（内部评测）≥3.5/5。
- **阶段 2**：数据迁移脚本通过演练；Display 类型 ≥3；上下文调试面板可用于 QA。
- **阶段 3**：Skill 原型评审通过；并行生成实验完成；引用追溯指标定义明确。

---

## 8. 风险与对策

| 风险 | 描述 | 对策 |
|------|------|------|
| 结构化输出失败 | 模型返回 JSON 不符合 Schema | 服务端增加 JSON 校验与降级文本提示；草稿面板允许用户编辑修正 |
| 上下文过长 | Markdown + 摘要易超 Token | 阶段 1 控制在 1500 token 内；阶段 2 引入压缩与缓存 |
| 数据迁移复杂 | `flowcharts` 替换为 `boards/containers` 需迁移 | 阶段 2 先完成设计与演练，再安排正式迁移窗口 |
| 底部对话栏交互复杂 | 多模式切换易混淆 | 通过草稿预览与模式标签区分；迭代指引文案与教程 |
| 资源投入不足 | 阶段 2、3 功能量大 | 按阶段评审可交付性，确保每阶段可单独上线 |

---

## 9. 待确认与后续决策

1. Markdown 项目说明的存储方案（独立表 vs. 对象存储）及访问控制策略。  
2. 思维导图前端组件选型（自研/第三方）与编辑能力范围。  
3. Board/Container 数据模型的迁移节奏、灰度计划与回滚策略。  
4. 分支管理与引用追溯的优先级：阶段 2 是否需要完整实现，或仅保留设计。  
5. 底部对话栏在移动端的呈现方式与适配成本。  
6. Skill 插件的业务需求列表与运营策略（阶段 3 前需确定）。

---

## 10. 附录

- 调研摘要：见《vilearning-项目探讨-251025.md》《vilearning-产品需求文档-251028.md》。  
- 火山引擎 DeepSeek 接入说明：参考 `/docs/API调用引导`。  
- 视觉参考：参照 `/docs/前端引导/前端设计引导.md`。  
- 备注：当前环境未接入 Serena 记忆写入能力，如需记录关键决策请手动追踪。

---
