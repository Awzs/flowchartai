# ViLearning 多Display平台实施总结与下一步行动

## 📋 核心方案总结

### 战略定位
**快速验证 + 模块化演进** - 先硬编码实现思维导图验证价值，再重构为可扩展架构

### 当前状态（2025-11 基线）
- 功能仍停留在单一流程图模式：前端基于 Excalidraw，AI 路由仅 `/api/ai/chat/flowchart`。
- 数据结构未改造：只有 `flowcharts` 表，尚无 `boards/displays/contexts` 表及迁移脚本。
- DisplayRegistry、ContextEngine、思维导图 Display 组件皆未落地，相关 PoC 尚未开展。
- 自动化测试、监控指标、质量报告体系尚未覆盖多 Display 场景。
- 结论：正式阶段尚未启动，需先完成准备期交付物，再进入阶段 0。

### 技术路线图 (11周完成)
```
Week 0: 准备期 (PoC、Registry 草案、迁移设计、上下文契约)
Week 1-2: 思维导图Display硬编码实现 (快速验证)
Week 3-4: 数据库激进重构 (boards + displays关系表)
Week 5-6: DisplayRegistry架构 (多Display底座)
Week 7-8: 上下文工程浅层实现 (选区/项目上下文)
Week 9-10: 测验模块独立面板 (类Anki学习)
Week 11+: 回归测试与上线监控
```

---

## 🎯 关键设计决策

### 1. DisplayRegistry - 插件化架构
```typescript
// 每个Display是一个"插件"
interface DisplayDefinition {
  type: 'flowchart' | 'mindmap' | 'quiz';
  schema: ZodSchema;           // 数据校验
  prompt: DisplayPrompt;       // Prompt配置
  renderer: ComponentType;     // 渲染组件
  exporter: ExportStrategy;    // 导出策略
}

// 优势: 新增Display只需注册，无需修改核心代码
```

### 2. 数据库激进重构
```sql
boards (工作板) 1:N displays (具体内容) 1:N contexts (上下文)
```

**为什么选择激进方案？**
- 长期可维护性强
- 支持多Display并存
- 上下文工程天然友好
- 虽然迁移复杂，但一次搞定

### 3. 上下文工程分两阶段
**浅层 (Week 7-8)**
- ✅ 选区上下文自动采集
- ✅ Token控制 (1500限制)
- ✅ 优先级排序 (选区 > 最新 > 项目)

**深层 (后续)**
- 📝 项目级知识图谱
- 📝 跨Display关联
- 📝 分支追溯

### 4. 思维导图技术选型: mind-elixir
**原因:**
- ✅ MIT许可证 (商业友好)
- ✅ 轻量级 (gzip ~50KB)
- ✅ 功能完整 (拖拽、缩放、导出)
- ✅ React友好

### 5. 测验模块: 独立学习面板
**特点:**
- 类似Anki的间隔重复算法
- 独立于白板的学习界面
- 进度跟踪与统计
- Markdown/CSV导出

---

## 📊 关键数据模型

### boards 表 (工作板)
```sql
- id: UUID (主键)
- user_id: UUID (关联用户)
- title: VARCHAR(255) (标题)
- description: TEXT (描述)
- display_type: VARCHAR(50) (主类型: flowchart/mindmap/quiz/mixed)
```

### displays 表 (内容单元)
```sql
- id: UUID (主键)
- board_id: UUID (关联工作板)
- display_type: VARCHAR(50) (类型)
- excalidraw_data: JSONB (白板原始数据)
- structured_payload: JSONB (结构化数据)
- ai_snapshot: JSONB (AI原始输出)
- position_x/y/width/height: 布局信息
```

### contexts 表 (上下文存储)
```sql
- id: UUID (主键)
- board_id: UUID (关联工作板)
- context_type: VARCHAR(50) (类型: selection/project/conversation)
- context_value: JSONB (上下文内容)
- token_count: INTEGER (Token计数)
- expires_at: TIMESTAMP (过期时间)
```

---

## 🚀 准备阶段行动清单（Week 0 / T0）

### 目标
在进入阶段 0 之前，完成底座 PoC、架构草案与质量兜底，确保后续阶段按计划推进。

### 关键任务包
1. **思维导图 PoC**
   - 引入 mind-elixir（及备选库）进行渲染、交互、导出评估。
   - 输出性能指标、交互体验与风险评估文档。
   - 交付物：PoC Demo、评估记录、备选方案对比。
2. **DisplayRegistry 雏形**
   - 在 `src/lib` 或 `src/components/displays` 建立最小可行接口及注册流程。
   - 将现有流程图注册为首个 Display，验证可热插拔。
   - 交付物：TypeScript 类型定义、样例注册代码、使用说明。
3. **数据迁移方案**
   - 设计 `boards/displays/contexts` 表结构草案，编写迁移脚本雏形。
   - 定义双写、灰度、回滚策略及监控指标。
   - 交付物：迁移设计文档、脚本原型、验证计划。
4. **上下文契约**
   - 梳理 Canvas Snapshot、AI Context、上下文缓存结构。
   - 输出前后端接口契约与扩展点说明。
   - 交付物：契约 Markdown、示例数据、序列图。
5. **质量保障基线**
   - 明确阶段 0-4 所需的单测/集成/端到端测试范围。
   - 规划性能、可用性、错误监控指标及告警阈值。
   - 交付物：测试计划、监控指标表、质量报告模板。

### 准入标准
- 以上五项交付物经产品/研发/设计评审通过。
- PoC 与脚本原型在本地完成 dry-run，无阻塞问题。
- 监控与测试方案纳入版本控制，后续阶段可直接复用。

### 阶段节奏提醒
- 阶段 0：在 Registry 雏形基础上实现思维导图 Display，保留快速验证姿势。
- 阶段 1：按迁移方案推进表结构改造，落实灰度与回滚。
- 后续阶段依照 PRD 路线执行，但需在每个阶段入口复核前置条件是否满足。

---

## ⚠️ 风险与应对

### 技术风险

| 风险 | 应对策略 |
|------|----------|
| mind-elixir不适合复杂场景 | 提前PoC测试，准备备选库 (reactflow) |
| 硬编码导致后续重构困难 | 保持模块化设计，重构时迁移成本可控 |
| 性能问题 | 限制节点数量 (默认120)，虚拟化渲染 |
| 底座缺失导致推进受阻 | 在 T0 完成 Registry/Context 基线评审后再进入阶段 0 |
| 测试与监控空白 | 与开发同步建设测试脚本与告警指标，纳入阶段验收 |

### 产品风险

| 风险 | 应对策略 |
|------|----------|
| 用户不接受多Display | A/B测试，收集反馈，快速迭代 |
| 思维导图价值不明 | 准备使用场景 (学习笔记、知识梳理) |
| 学习成本高 | 渐进式引导，默认保持流程图模式 |
| 路线图过于紧凑 | 在阶段评审中滚动评估风险，必要时调整节奏 |

### 数据迁移风险

| 风险 | 应对策略 |
|------|----------|
| 迁移失败 | 双写+灰度切换+回滚机制 |
| 数据不一致 | 自动化验证脚本 |
| API性能下降 | 监控响应时间，及时优化 |
| 监控缺失 | 在迁移脚本上线前接入数据质量监控与报警 |

---

## 📈 成功指标

### 准备期 T0 成功标准
- [ ] mind-elixir PoC 通过评审，性能/交互指标记录齐备
- [ ] DisplayRegistry 雏形合并主分支，可注册流程图 Display
- [ ] 数据迁移草案 + 脚本雏形完成 dry-run，灰度/回滚方案评审通过
- [ ] 上下文契约文档落地，示例数据对接完成
- [ ] 测试计划与监控指标表归档，质量报告模板准备就绪

### 阶段 0 成功标准
- [ ] 思维导图 Display 生成成功率 ≥80%，响应时间 <5 秒
- [ ] 基础编辑/保存链路稳定，自动化测试覆盖生成与保存
- [ ] 新模式监控指标上线，错误率与性能数据可观测

### 阶段 1 成功标准
- [ ] 新老数据读写 100% 兼容，迁移 0 数据丢失
- [ ] 灰度发布与回滚脚本演练通过，监控未告警
- [ ] API 响应时间无明显下降，数据质量监控上线

### 阶段 2 成功标准
- [ ] 新 Display 注册无阻，流程图/思维导图均通过回归测试
- [ ] Display 切换流畅，性能指标符合既定基线
- [ ] Prompt 配置化管理与脚本测试完成，文档同步更新

### 阶段 3 成功标准
- [ ] 上下文命中率 ≥70%，Token 控制不超限
- [ ] 侧栏上下文渲染延迟 <100ms，缓存策略有监控告警
- [ ] 前后端契约文档更新到位，自动化测试覆盖核心路径

### 阶段 4 成功标准
- [ ] 测验生成成功率 ≥80%，学习面板操作流畅
- [ ] 学习进度统计准确，可导出并经测试验证
- [ ] 关键交互纳入监控告警，用户反馈渠道建立

---

## 🗂️ 文档与沟通同步

- **版本号管理**：PRD、实施总结、迁移方案、测试计划需在每次阶段评审后同步更新版本号与变更记录。
- **跨团队评审**：产品/研发/设计需在阶段切换前召开评审会议，确认前置条件达成，再发起下一阶段开发。
- **资料归档**：PoC 报告、迁移脚本说明、上下文契约、监控指标配置集中存放于 `docs/Vilearning项目需求文档/`，并在 README 中挂接索引。
- **反馈机制**：阶段结束输出经验总结与质量报告，沉淀到知识库或 `serena` 记忆，供后续迭代复用。

---

## 🛠️ 技术债务与后续优化

### 必须处理 (Week 11+)
- [ ] 单元测试覆盖率达到80%
- [ ] E2E测试覆盖核心流程
- [ ] 性能监控与告警
- [ ] 错误追踪系统接入

### 可选优化 (后续迭代)
- [ ] WebWorker渲染优化
- [ ] 上下文智能压缩
- [ ] 跨Display知识图谱
- [ ] 多模型并行调用

---

## ✅ 近期行动建议

1. 完成 mind-elixir PoC，并输出性能与交互评估报告。
2. 在仓库中提交 DisplayRegistry 最小实现，将流程图 Display 注册入表。
3. 编写 `boards/displays/contexts` 迁移脚本原型，完成本地 dry-run 与数据验证。
4. 梳理 Canvas/AI 上下文数据契约，形成示例 payload 与接口说明。
5. 建立测试与监控基线（自动化脚本、指标文档、质量报告模板）。

---

## 💡 快速开始清单

### 环境准备
```bash
# 1. 确保Node.js ≥20
node --version

# 2. 安装依赖
pnpm install

# 3. 启动开发服务器
pnpm dev

# 4. 访问 http://localhost:3000
```

## 📞 需要确认的问题

在开始实施前，请确认:

1. **思维导图 PoC**：验证范围、性能指标、评审节奏是否达成共识？
2. **DisplayRegistry 雏形**：预计放置路径、接口命名、团队约定是否已确认？
3. **数据迁移策略**：灰度窗口、回滚触发条件对业务影响如何评估？
4. **上下文契约**：前后端数据结构及扩展点是否需要额外字段/元信息？
5. **质量保障计划**：测试与监控资源是否落实，是否需要额外工具支持？

---

## 📚 参考资料

### 核心文档
- `vilearning-产品需求文档-精准实施方案.md` - 完整PRD
- `architecture_evolution.md` - 架构演进图
- `database_migration_flow.md` - 数据库迁移路径
- `display_registry_workflow.md` - DisplayRegistry原理
- `context_engine_workflow.md` - 上下文工程流程

### 代码位置
- 当前流程图实现: `src/app/api/ai/chat/flowchart/route.ts`
- 侧栏组件: `src/components/canvas/ai-chat-sidebar.tsx`
- 白板组件: `src/components/canvas/excalidraw-wrapper.tsx`
- Mermaid转换: `src/lib/mermaid-converter.ts`

---

**总结**: 本方案采用"先验证，后重构"的策略，约11周完成多 Display 平台的核心能力。关键成功因素是快速迭代 + 保持模块化设计，并通过准备期兜底、阶段评审与质量监控，确保快速出成果且便于长期维护。

**下一步**: 完成准备期交付物评审 → 启动阶段 0 实施 → 滚动校准路线图，确保多 Display 演进有据可依。
