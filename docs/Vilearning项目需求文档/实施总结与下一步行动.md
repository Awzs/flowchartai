# ViLearning 多Display平台实施总结与下一步行动

## 📋 核心方案总结

### 战略定位
**快速验证 + 模块化演进** - 先硬编码实现思维导图验证价值，再重构为可扩展架构

### 技术路线图 (10周完成)
```
Week 1-2: 思维导图Display硬编码实现 (快速验证)
Week 3-4: 数据库激进重构 (boards + displays关系表)
Week 5-6: DisplayRegistry架构 (多Display底座)
Week 7-8: 上下文工程浅层实现 (选区/项目上下文)
Week 9-10: 测验模块独立面板 (类Anki学习)
```

---

## 🎯 关键设计决策

### 1. DisplayRegistry - 插件化架构
```typescript
// 每个Display是一个"插件"
interface DisplayDefinition {
  type: 'flowchart' | 'mindmap' | 'quiz';
  schema: ZodSchema;           // 数据校验
  prompt: DisplayPrompt;       // Prompt配置
  renderer: ComponentType;     // 渲染组件
  exporter: ExportStrategy;    // 导出策略
}

// 优势: 新增Display只需注册，无需修改核心代码
```

### 2. 数据库激进重构
```sql
boards (工作板) 1:N displays (具体内容) 1:N contexts (上下文)
```

**为什么选择激进方案？**
- 长期可维护性强
- 支持多Display并存
- 上下文工程天然友好
- 虽然迁移复杂，但一次搞定

### 3. 上下文工程分两阶段
**浅层 (Week 7-8)**
- ✅ 选区上下文自动采集
- ✅ Token控制 (1500限制)
- ✅ 优先级排序 (选区 > 最新 > 项目)

**深层 (后续)**
- 📝 项目级知识图谱
- 📝 跨Display关联
- 📝 分支追溯

### 4. 思维导图技术选型: mind-elixir
**原因:**
- ✅ MIT许可证 (商业友好)
- ✅ 轻量级 (gzip ~50KB)
- ✅ 功能完整 (拖拽、缩放、导出)
- ✅ React友好

### 5. 测验模块: 独立学习面板
**特点:**
- 类似Anki的间隔重复算法
- 独立于白板的学习界面
- 进度跟踪与统计
- Markdown/CSV导出

---

## 📊 关键数据模型

### boards 表 (工作板)
```sql
- id: UUID (主键)
- user_id: UUID (关联用户)
- title: VARCHAR(255) (标题)
- description: TEXT (描述)
- display_type: VARCHAR(50) (主类型: flowchart/mindmap/quiz/mixed)
```

### displays 表 (内容单元)
```sql
- id: UUID (主键)
- board_id: UUID (关联工作板)
- display_type: VARCHAR(50) (类型)
- excalidraw_data: JSONB (白板原始数据)
- structured_payload: JSONB (结构化数据)
- ai_snapshot: JSONB (AI原始输出)
- position_x/y/width/height: 布局信息
```

### contexts 表 (上下文存储)
```sql
- id: UUID (主键)
- board_id: UUID (关联工作板)
- context_type: VARCHAR(50) (类型: selection/project/conversation)
- context_value: JSONB (上下文内容)
- token_count: INTEGER (Token计数)
- expires_at: TIMESTAMP (过期时间)
```

---

## 🚀 第一阶段行动计划 (Week 1-2)

### 目标
在现有架构上**硬编码**实现思维导图Display，快速验证多Display价值

### 关键任务

#### Day 1-3: 思维导图库选型与集成
```bash
# 1. 安装mind-elixir
pnpm add mind-elixir mind-elixir-react

# 2. 创建MindMapDisplay组件
touch src/components/displays/MindMapDisplay.tsx

# 3. 基础渲染测试
# 验证库的基本功能
```

#### Day 4-7: AI生成链路
```typescript
// 新增路由: /api/ai/chat/mindmap
// 类似现有flowchart路由，但输出思维导图JSON
```

**Prompt模板 (参考流程图):**
```
你是一个思维导图生成专家。
请将用户输入转换为层级思维导图。

要求:
1. 输出严格的JSON格式
2. 根节点明确
3. 子节点层级清晰
4. 每个节点文字简洁 (<20字)

格式:
{
  "root": "主题",
  "children": [
    {
      "node": "分支1",
      "children": [
        {"node": "子分支1"},
        {"node": "子分支2"}
      ]
    }
  ]
}
```

#### Day 8-10: 侧栏集成
```typescript
// 更新 ai-chat-sidebar.tsx
// 添加"思维导图"模式选择
const AI_ASSISTANT_MODES = {
  text_to_flowchart: {...},
  text_to_mindmap: {...},     // 新增
  image_to_flowchart: {...}
};
```

#### Day 11-14: 数据持久化与测试
- 写入现有 `flowcharts` 表
- 基础编辑功能 (增删改节点)
- 端到端测试

### 交付物
- ✅ 用户可以生成思维导图
- ✅ 基础编辑能力
- ✅ 数据保存与读取
- ✅ 生成成功率 ≥80%

---

## ⚠️ 风险与应对

### 技术风险

| 风险 | 应对策略 |
|------|----------|
| mind-elixir不适合复杂场景 | 提前PoC测试，准备备选库 (reactflow) |
| 硬编码导致后续重构困难 | 保持模块化设计，重构时迁移成本可控 |
| 性能问题 | 限制节点数量 (默认120)，虚拟化渲染 |

### 产品风险

| 风险 | 应对策略 |
|------|----------|
| 用户不接受多Display | A/B测试，收集反馈，快速迭代 |
| 思维导图价值不明 | 准备使用场景 (学习笔记、知识梳理) |
| 学习成本高 | 渐进式引导，默认保持流程图模式 |

### 数据迁移风险

| 风险 | 应对策略 |
|------|----------|
| 迁移失败 | 双写+灰度切换+回滚机制 |
| 数据不一致 | 自动化验证脚本 |
| API性能下降 | 监控响应时间，及时优化 |

---

## 📈 成功指标

### Week 1-2 成功标准
- [x] 思维导图生成成功率 ≥80%
- [x] 响应时间 <5秒
- [x] 基础编辑操作流畅
- [x] 数据持久化正常

### Week 3-4 成功标准
- [x] 新老数据读写100%兼容
- [x] 迁移0数据丢失
- [x] API响应时间无明显下降

### Week 5-6 成功标准
- [x] 新Display热插拔无问题
- [x] 切换Display类型流畅
- [x] 代码复用度提升 ≥50%

### Week 7-8 成功标准
- [x] 上下文命中率 ≥70%
- [x] Token控制不超限
- [x] 用户体验流畅

### Week 9-10 成功标准
- [x] 测验生成成功率 ≥80%
- [x] 学习面板操作流畅
- [x] 进度数据准确

---

## 🛠️ 技术债务与后续优化

### 必须处理 (Week 11+)
- [ ] 单元测试覆盖率达到80%
- [ ] E2E测试覆盖核心流程
- [ ] 性能监控与告警
- [ ] 错误追踪系统接入

### 可选优化 (后续迭代)
- [ ] WebWorker渲染优化
- [ ] 上下文智能压缩
- [ ] 跨Display知识图谱
- [ ] 多模型并行调用

---

## 💡 快速开始清单

### 环境准备
```bash
# 1. 确保Node.js ≥20
node --version

# 2. 安装依赖
pnpm install

# 3. 启动开发服务器
pnpm dev

# 4. 访问 http://localhost:3000
```

### 第一周任务分解
```bash
Day 1:
├─ 安装mind-elixir库
├─ 创建MindMapDisplay组件
└─ 验证基础渲染

Day 2-3:
├─ 实现简单JSON → 思维导图转换
├─ 测试拖拽、缩放等基础功能
└─ 确定数据结构

Day 4-5:
├─ 创建 /api/ai/chat/mindmap 路由
├─ 参考flowchart路由实现
└─ Prompt模板调优

Day 6-7:
├─ 集成到侧栏 (AI模式切换)
├─ 测试AI生成流程
└─ 修复bug

Day 8-10:
├─ 数据持久化
├─ 基础编辑功能
└─ 端到端测试
```

---

## 📞 需要确认的问题

在开始实施前，请确认:

1. **mind-elixir库选型**是否满意？是否需要我先做一个PoC验证？
2. **数据库激进重构**的时间窗口是否合适？是否会影响现有用户？
3. **阶段0 (流程图链路加固)**是否有必须优先处理的问题？
4. **测验模块**的学习算法是否需要我详细设计？

---

## 📚 参考资料

### 核心文档
- `vilearning-产品需求文档-精准实施方案.md` - 完整PRD
- `architecture_evolution.md` - 架构演进图
- `database_migration_flow.md` - 数据库迁移路径
- `display_registry_workflow.md` - DisplayRegistry原理
- `context_engine_workflow.md` - 上下文工程流程

### 代码位置
- 当前流程图实现: `src/app/api/ai/chat/flowchart/route.ts`
- 侧栏组件: `src/components/canvas/ai-chat-sidebar.tsx`
- 白板组件: `src/components/canvas/excalidraw-wrapper.tsx`
- Mermaid转换: `src/lib/mermaid-converter.ts`

---

**总结**: 本方案采用"先验证，后重构"的策略，10周内完成多Display平台的核心功能。关键成功因素是快速迭代 + 保持模块化设计，确保既能快速出成果，又为长期维护奠定基础。

**下一步**: 确认技术选型 → 启动Week 1任务 → 每周末验收进展 → 及时调整策略
