# 质量保障预案（思维导图 Display 准备期）

## 1. 目标
在进入阶段 0 之前，建立可执行的测试、监控与验收体系，确保思维导图功能上线后可观测、可回滚、可验证。

## 2. 测试策略
| 测试层级 | 覆盖范围 | 工具/方案 | 当前状态 | 下一步 |
| -------- | -------- | -------- | -------- | ------ |
| 单元测试 | `mindmap-converter`、流式 chunk 合并、`paletteMeta` 配置 | Vitest | 进行中 | 增加 chunk 顺序错乱/空 payload 场景 |
| 组件测试 | `MindMapDisplay` 渲染、浮动 toolbar、双击文本编辑 | React Testing Library | 未编写 | 模拟样式态/文本态切换、快照校验 |
| 接口测试 | `/api/ai/chat/mindmap` 流式 SSE、模型参数 | Supertest/Next Test Utils | 未编写 | 校验 chunk 顺序、done 信号、非法模型请求 |
| 集成测试 | 生成模式（流式落白板）、对话模式（不落白板） | Playwright | 未编写 | 构建两套场景，验证模式切换、Undo/Redo |
| 回归测试 | 左侧组件栏与 DisplayRegistry 同步、流程图/思维导图工具栏切换 | Playwright | 未编写 | 在阶段 2 前纳入 CI，覆盖不同组件插入与编辑 |

## 3. 监控指标
| 指标 | 说明 | 采集方案 | 阈值/告警 |
| ---- | ---- | ---- | ---- |
| `mindmap_generation.success_rate` | 成功解析并渲染的请求占比 | 后端记录 + 前端成功埋点 | <80% 触发告警 |
| `mindmap_generation.latency` | 从请求发起到工具完成的时间 | 前端计时上报 | >5s 告警 |
| `mindmap_generation.node_count` | 每次生成的节点数量 | 解析元信息 | >200 节点触发提示 |
| `/api/ai/chat/mindmap` 错误率 | API 4xx/5xx 占比 | Next API 日志 + 监控 | >2% 告警 |
| 前端渲染耗时 | `MindMapDisplay` 首屏渲染耗时 | Performance API | >250ms 提示 |
| 流式 chunk 延迟 | chunk 间隔/累计耗时 | SSE 客户端埋点 | 任意 chunk >2s 触发日志 |
| 模式误触率 | 在对话模式下误写白板的次数 | 前端埋点 | >0 立即告警（理论上不应发生） |

## 4. 验收流程
1. **功能验收**：依据阶段 0 成功标准检查生成成功率、响应时间、保存链路。
2. **稳定性验收**：通过上述监控指标，连续 24h 无异常波动。
3. **文档验收**：测试用例、告警策略、手动回滚步骤纳入仓库文档。

## 5. 回滚策略
- 若 mindmap 功能引发严重故障，可通过 Feature Flag 或配置化方式关闭 `text_to_mindmap` 模式。
- API 层需保留版本号，支持快速回退至仅 flowchart 模式。
- 数据层在迁移阶段采用双写策略，确保回滚时不会丢失旧数据。

## 6. 后续计划
- 阶段 0 内完成单元/组件测试与基础监控埋点。
- 阶段 1 引入端到端测试与实时告警，纳入 CI/CD。
- 阶段 2 推进多 Display 回归测试矩阵，实现质量报告自动化。
