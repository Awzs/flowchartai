# 质量保障预案（思维导图 Display 准备期）

## 1. 目标
在进入阶段 0 之前，建立可执行的测试、监控与验收体系，确保思维导图功能上线后可观测、可回滚、可验证。

## 2. 测试策略
| 测试层级 | 覆盖范围 | 工具/方案 | 当前状态 | 下一步 |
| -------- | -------- | -------- | -------- | ------ |
| 单元测试 | `mindmap-converter` 解析、节点统计、fallback 逻辑 | Vitest + React Testing Library | 未编写 | 阶段 0 内补齐，覆盖正常/异常路径 |
| 组件测试 | `MindMapDisplay` 渲染、空态展示 | React Testing Library | 未编写 | 模拟不同节点规模，校验渲染耗时、空态文案 |
| 接口测试 | `/api/ai/chat/mindmap` 鉴权、限流、工具调用解析 | Supertest/Next Test Utils | 未编写 | 构造合法/非法请求、模拟工具输出 |
| 集成测试 | 侧栏对话生成 mindmap 的端到端流程 | Playwright | 未编写 | 建立最小场景，验证生成->渲染->消息展示 |
| 回归测试 | Flowchart/mindmap 双 Display 切换 | Playwright | 未编写 | 在阶段 2 前纳入持续集成 |

## 3. 监控指标
| 指标 | 说明 | 采集方案 | 阈值/告警 |
| ---- | ---- | ---- | ---- |
| `mindmap_generation.success_rate` | 成功解析并渲染的请求占比 | 后端记录 + 前端成功埋点 | <80% 触发告警 |
| `mindmap_generation.latency` | 从请求发起到工具完成的时间 | 前端计时上报 | >5s 告警 |
| `mindmap_generation.node_count` | 每次生成的节点数量 | 解析元信息 | >200 节点触发提示 |
| `/api/ai/chat/mindmap` 错误率 | API 4xx/5xx 占比 | Next API 日志 + 监控 | >2% 告警 |
| 前端渲染耗时 | `MindMapDisplay` 首屏渲染耗时 | Performance API | >250ms 提示 |

## 4. 验收流程
1. **功能验收**：依据阶段 0 成功标准检查生成成功率、响应时间、保存链路。
2. **稳定性验收**：通过上述监控指标，连续 24h 无异常波动。
3. **文档验收**：测试用例、告警策略、手动回滚步骤纳入仓库文档。

## 5. 回滚策略
- 若 mindmap 功能引发严重故障，可通过 Feature Flag 或配置化方式关闭 `text_to_mindmap` 模式。
- API 层需保留版本号，支持快速回退至仅 flowchart 模式。
- 数据层在迁移阶段采用双写策略，确保回滚时不会丢失旧数据。

## 6. 后续计划
- 阶段 0 内完成单元/组件测试与基础监控埋点。
- 阶段 1 引入端到端测试与实时告警，纳入 CI/CD。
- 阶段 2 推进多 Display 回归测试矩阵，实现质量报告自动化。
