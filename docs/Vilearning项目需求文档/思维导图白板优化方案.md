# 思维导图白板呈现与编辑优化方案（修正版）

> 目标：**白板作为容器，Display保持原生**。让思维导图和流程图在同一画布共存，各自保持原生编辑能力，由白板统一管理位置、导出和协作。
>
> 状态：已实现CanvasDisplayHost容器，MindMapDisplay原生渲染。需强化容器能力和工具栏集成。

---

## 1. 现状诊断（修正后）

| 模块 | 当前实现 | 存在问题 |
| --- | --- | --- |
| 数据生成 | `/api/ai/chat/mindmap` → MindElixir JSON → `mindmaps` 表 | 数据未接入boards/displays体系，独立存储 |
| 白板呈现 | `CanvasDisplayHost` + `react-rnd` 渲染MindMapDisplay卡片 | 基础拖拽/缩放可用，但缺少对齐、吸附、旋转 |
| 编辑能力 | MindMapDisplay使用原生mind-elixir，仅只读 | 未开放editable模式，工具栏缺失 |
| 工具栏/属性面板 | 白板无Display感知的动态工具栏 | 选中MindMap时不显示思维导图专用工具 |
| 交互反馈 | AI生成后toast & 悬浮卡片 | 缺少Display级操作反馈和统一导出入口 |

---

## 2. 需求拆解（修正后）

1. **Display容器化**：强化CanvasDisplayHost，支持对齐线、吸附网格、旋转手柄、多选框选
2. **原生渲染**：MindMapDisplay保持mind-elixir原生，FlowchartDisplay保持Excalidraw原生
3. **动态工具栏**：白板根据选中Display类型自动切换工具栏（MindMap工具 vs Flowchart工具）
4. **统一导出**：CanvasDisplayHost调用各Display的exporter，提供PNG/SVG/JSON导出
5. **Display间协同**：
   - 选区跨Display：支持同时选中思维导图节点和流程图元素
   - 上下文共享：ContextEngine聚合多Display数据供AI使用
   - 模板联动：AI生成的模板可同时包含MindMap和Flowchart

### 2.1 入门模板与AI入口

- **模板驱动**：提供"课堂脚本""产品评审""学习路径"模板，AI生成后自动创建MindMap和Flowchart双Display
- **AI入口统一**：侧栏AI助手支持"生成到思维导图""生成到流程图""生成混合模板"
- **多模态规划**：预留图片/PDF输入能力，AI解析后自动选择Display类型

---

## 3. 方案设计（修正后）

### 3.1 Display容器化架构

**核心原则**：白板作为容器，Display保持原生

```
┌─────────────────────────────────────────┐
│        Board Canvas (白板容器)           │
│  - 位置/大小/层级管理                    │
│  - 全局选区/工具栏                       │
│  - 统一导出/协作框架                     │
├─────────────────────────────────────────┤
│  MindMap Display  │  Flowchart Display │
│  (mind-elixir)    │  (Excalidraw)      │
│  - 原生渲染        │  - 原生渲染         │
│  - 自治编辑        │  - 自治编辑         │
└─────────────────────────────────────────┘
```

1. **CanvasDisplayHost 增强**
   - 使用 react-rnd 提供统一拖拽、缩放、旋转能力
   - 管理Display位置、大小、层级（z-index）
   - 提供全局选区、多选、对齐线、吸附网格
   - 统一导出API（调用各Display的exporter）

2. **MindMap Display 原生渲染**
   - 直接使用 mind-elixir-react，不转换格式
   - 保留所有原生能力：快捷键、主题、布局算法
   - 在Display内部实现工具栏（同级/子级、折叠、配色）
   - 通过DisplayRegistry暴露编辑能力给白板

3. **Flowchart Display 原生渲染**
   - 直接使用 @excalidraw/excalidraw
   - 保留协作、undo/redo、导出能力
   - 工具栏保持Excalidraw默认

4. **Display间通信**
   - 选区跨Display：白板管理全局选区ID列表
   - 上下文共享：ContextEngine聚合各Display数据
   - 事件冒泡：Display内部事件→白板统一处理

### 3.2 工具栏动态切换

| 场景 | 解决方案 |
| --- | --- |
| 选中Flowchart Display | 显示Excalidraw默认工具栏 |
| 选中MindMap Display | 工具栏切换为MindMap模式：添加同级/子级、折叠/展开、主题/布局切换、快速样式 |
| 多选混合Display | 显示通用工具（复制、删除、对齐），提示"混合选区专用工具受限" |
| 未选中任何Display | 显示白板级工具（框选、放大/缩小、添加Display） |

### 3.3 左侧组件栏（通用节点）

- 参照BoardMix，左栏常驻基础组件：容器、形状/流程图、连接线、文本、思维导图、便签、画笔、表格、文档、卡片看板
- 每个按钮通过DisplayRegistry注册，拖拽到白板自动创建对应Display
- 思维导图按钮：在中心位置创建MindMap Display（空状态或模板）
- 流程图按钮：创建Flowchart Display

### 3.4 AI入口与模板联动

1. **AI侧栏增强**
   - 模式切换："生成到Display" vs "对话模式"
   - Display类型选择：思维导图、流程图、混合模板
   - 流式输出：实时渲染到目标Display

2. **模板系统**
   - 模板包含Display配置（类型、位置、数据）
   - AI生成后自动创建多个Display并布局
   - 支持模板局部替换（选中Display后"应用模板"）

3. **Display级AI操作**
   - 选中MindMap Display后，工具栏显示"AI续写""AI优化"按钮
   - 选中Flowchart Display后，显示"AI扩展"按钮
   - AI操作自动携带Display上下文

### 3.5 导出与协作

1. **统一导出**
   ```typescript
   // CanvasDisplayHost提供统一导出
   const exportBoard = async (format: 'png' | 'svg' | 'pdf' | 'json') => {
     // 1. 获取所有Display的导出数据
     // 2. 合成到统一画布
     // 3. 导出最终文件
   };
   ```

2. **协作框架**
   - 白板级：光标位置、选区同步
   - Display级：由各自引擎处理（Excalidraw协作 vs MindMap协作）
   - 权限控制：白板只读时所有Display只读

---

## 4. 分阶段实施路径

| 阶段 | 目标 | 关键任务 |
| --- | --- | --- |
| Phase A：容器强化 | CanvasDisplayHost支持旋转、对齐、吸附 | 1) 添加旋转手柄；2) 对齐线/吸附网格；3) 多选框选；4) Display级工具栏 |
| Phase B：MindMap增强 | 开放editable模式，集成工具栏 | 1) MindMapDisplay editable=true；2) 浮动工具条（同级/子级）；3) 主题/布局切换；4) 快捷键支持 |
| Phase C：工具栏动态切换 | 白板感知Display类型 | 1) 选区检测；2) 工具栏状态管理；3) 混合选区策略；4) 左侧组件栏配置化 |
| Phase D：导出与协作 | 统一导出，协作框架 | 1) Display exporter集成；2) 导出合成；3) 协作光标同步；4) Undo/Redo跨Display |

每阶段需产出：设计稿、技术方案、测试用例、监控埋点。

---

## 5. 参考与启示

- **BoardMix**：无限画布 + 多类型组件（思维导图、流程图、表格），各组件保持原生编辑能力
- **FigJam**：容器化架构，组件自治，统一导出和协作
- **Miro**：插件化Display系统，支持第三方组件接入

---

## 6. 技术风险与应对

| 风险 | 影响 | 缓解措施 |
| --- | --- | --- |
| Display间坐标转换 | 位置计算复杂 | 统一使用白板坐标系，Display内部转换 |
| 性能问题 | 多Display同时渲染卡顿 | 虚拟化、懒加载、Display级shouldComponentUpdate |
| 选区冲突 | 跨Display选区逻辑复杂 | 白板统一管理选区ID，Display内部处理细节 |
| 导出兼容性 | 不同Display导出格式差异 | 统一转换为SVG/Canvas再合成 |

---

## 7. 验收与测试

1. **功能测试**：
   - 可拖拽、缩放、旋转MindMap/Flowchart Display
   - 工具栏根据选区类型自动切换
   - 支持多Display框选、对齐、删除
   - 导出包含所有Display的完整图片

2. **性能测试**：
   - 10个Display同时渲染无卡顿
   - 拖拽响应时间<100ms

3. **兼容性**：
   - 移动端支持基本查看
   - 不影响仅使用Flowchart的用户

4. **UX验证**：
   - 对照BoardMix关键交互（拖拽、工具栏、导出）
   - 完成可用性走查

---

> 注：本方案已修正为"白板容器 + Display自治"架构，删除MindElixir→Excalidraw转换相关内容。
