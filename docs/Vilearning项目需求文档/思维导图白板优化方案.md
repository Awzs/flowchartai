# 思维导图白板呈现与编辑优化方案（讨论稿）

> 目标：让思维导图节点像流程图元素一样直落 ViLearning 白板，并支持与流程图一致的编辑体验，同时保留 MindMap 专属的组织与批量操作能力。
>
> 状态：阶段 2 后，思维导图以 MindMapDisplay 卡片形式悬浮在画布上，可拖拽但不可直接在白板层级编辑，工具栏/样式面板仍以流程图为主。

---

## 1. 现状诊断

| 模块 | 当前实现 | 存在问题 |
| --- | --- | --- |
| 数据生成 | `/api/ai/chat/mindmap` → MindElixir JSON → `mindmaps` 表 | 结构化数据未转为 Excalidraw 元素，无法进入 Excalidraw 的 undo/redo 与协作体系 |
| 白板呈现 | `CanvasDisplayHost` 渲染 MindMapDisplay 卡片 | 卡片只是 iframe/React 容器，非画布节点；无法与流程图节点对齐、吸附或统一导出 |
| 编辑能力 | 侧栏消息中提供预览、JSON 查看；无画布级操作 | 用户无法在白板直接拖拽节点、改字体/线条；与流程图体验割裂 |
| 工具栏/属性面板 | 始终显示 Excalidraw 默认工具 | Mindmap 模式下缺少快捷添加子节点、批量配色等常用操作 |
| 交互反馈 | AI 成功生成后 toast & 卡片；无统一“透明窗口”归组 | Mindmap 与 Flowchart 实体边界不明显，难以区分两个 Display |

---

## 2. 需求拆解

1. **节点直落白板**：Mindmap 的根节点、分支、连线都要成为 Excalidraw 元素，可选中并触发工具栏；与流程图共享缩放、导出、协作能力。
2. **透明外层窗口**：提供一个可拖拽/缩放的“Mindmap 区域框”，仅用于表示同一导图的空间范围，不遮挡底层节点。
3. **编辑体验**：
   - 白板上可直接拖拽节点、拉伸分支、修改文本。
   - 选中 Mindmap 节点时，顶部工具栏切换为 Mindmap 工具（添加同级/子级、折叠、配色）。
   - 支持左侧快速面板（类似 BoardMix/XMind），调整字体、颜色、主题、分支布局。
4. **双 Display 共存**：流程图与思维导图可以在同一画布混排，工具栏根据当前选区类型自动切换；同一时刻只激活一种模式。
5. **可参考能力**：
   - BoardMix：思维导图节点即画布元素，可无限画布拖拽；提供浮动工具条（新增节点、主题切换）。
   - XMind：提供“鱼骨样式/逻辑图”等布局与智能主题配色；节点双击编辑、快捷键添加分支。

### 2.1 入门模板与 AI 入口

- **模板驱动**：借鉴 BoardMix「模板社区 → 一键生成」体验，在 ViLearning 中提供“课堂脚本”“产品评审”“学习路径”三类首批模板，用户选择模板后由 AI 自动填充 Mindmap/Flowchart 骨架。
- **AI 入口统一**：在画布左上角补充「AI 助手」按钮，外层语义与主页保持一致；Mindmap/Flowchart/教案/PPT 生成入口位于同一面板内，强调“文本描述即可开始”。
- **多模态规划**：近期仍聚焦文本输入，但在文案及技术设计中预留图片/网页解析的扩展说明（如“上传教材 PDF 后一键生成思维导图”的潜在能力）。

---

## 3. 方案设计

### 3.1 数据与渲染管线

1. **MindElixir → Excalidraw 转换器**
   - 新建 `mindmap-to-excalidraw.ts`：
     - 递归遍历 `MindElixirData.nodeData`，生成中心主题、一级/二级子节点。
     - 节点使用圆角矩形或 pill 形状；连线使用曲线（贝塞尔）模拟 Mindmap 线条；颜色取自 MindElixir theme。
     - 生成额外 metadata（层级、父节点 id、branch index），用于后续编辑。
2. **透明窗口（MindmapFrame）**
   - 通过 `CanvasDisplayHost` 维护 `MindmapFrame` 对象，只绘制半透明边框和标题，背景透明。
   - Frame 内的实际节点直接写入 Excalidraw scene，并在 metadata 中记录 `mindmapId`，便于批量选中/移动。
3. **双向同步**
   - 白板修改节点后，监听 `excalidrawAPI.onChange`，将 Mindmap 节点集合重建为 MindElixir 数据结构，写回 `mindmaps` 表 & DisplayRegistry。
   - AI 生成新导图时，先更新数据库，再调用转换器写入画布。

### 3.2 编辑与工具栏

| 场景 | 解决方案 |
| --- | --- |
| 选中流程图元素 | 显示 Excalidraw 默认工具栏（当前行为） |
| 选中 Mindmap 节点 | 工具栏切换为 Mindmap 模式：
- 添加同级/子级按钮（快捷键 Enter / Tab）
- 折叠/展开子树
- 主题/布局切换（左/右、鱼骨、时间轴）
- 快速样式（颜色、字体、线条粗细） |
| 多选含两种类型 | 工具栏默认流控模式，同时弹出提示“混合选区暂不支持 Mindmap 快捷编辑” |

### 3.3 左侧属性面板

- 可参考 BoardMix 的“风格”浮层：点击 Mindmap 节点时，侧栏出现主题色、字体、节点样式、图标/图片插入等选项。
- Panel 与 AI 侧栏错位：Mindmap Panel 可从左侧滑入（保持右侧 AI），或悬浮在节点附近。

### 3.4 交互流程

1. 用户在 AI 侧栏选择“Text to Mindmap” → 得到 MindElixir JSON。
2. 数据保存 `mindmaps`，并触发转换器将节点写入 Excalidraw；生成 MindmapFrame 覆盖区域。
3. 用户可直接拖拽节点；如需添加分支可用快捷键或工具栏按钮。
4. 当用户拖动 Frame 或选中 Frame 边缘时，整体 Mindmap 会平移；框体背景透明，仅保留标题和轮廓。
5. 保存/导出：流程图与Mindmap元素统一包含在 Excalidraw JSON 中，可导出 PNG/SVG；Mindmap 另存 MindElixir 数据（供 AI 继续拓展）。

### 3.5 AI 入口与模板联动

1. 在透明 MindmapFrame 的标题栏内增加「AI 续写」「模板替换」按钮，点击后自动携带当前节点上下文调用 AI。
2. 模板选择器支持“局部替换”：用户可在 Frame 中切换布局（左右 / 鱼骨 / 时间线），或将某分支替换为模板片段（例如“课堂评价 Rubric”）。
3. 所有 AI 操作写入 `contexts` 表，方便后续在其它 Display（如 Quiz）中复用，形成 BoardMix 所强调的“全局知识记忆”。

### 3.6 流式输出与双层编辑

1. **流式输出链路**：
   - 后端通过 SSE 返回 `mindmap_chunk`/`mindmap_done` 事件；前端根据 chunk 分段建树，优先渲染中心节点与一级分支，其余节点按层级递增显示，营造「不断生长」的体验。
   - 侧栏同步展示生成进度（百分比/节点数），如遇解析失败可即时 fallback，不必等待整图完成。
2. **编辑双状态**：
   - *样式编辑态*：单击节点后出现悬浮工具条（加子节点/同级、主题色、线条样式、插入表情/链接），与 BoardMix 的浮动 toolbar 类似。
   - *文本编辑态*：双击节点或按 `Enter` 进入文本编辑，弹出迷你面板（字体、字号、加粗/斜体、对齐方式）；编辑完成后 `Esc` 或点击空白退出。
   - 样式/文本面板都需要可扩展 hooks，确保未来流程图节点也能共享同一浮动组件体系。

### 3.7 左侧组件栏与通用节点

- 左栏常驻一列无 AI 的基础组件，顺序参考博思白板：容器、形状/流程图、连接线、文本、思维导图、便签、画笔、表格、文档、卡片看板，底部「更多」可展开表格模版等。
- 每个按钮默认插入对应 Display/元素。思维导图按钮在白板中心插入空 Frame，可配合 AI 在 Frame 内续写。
- 后续新增组件需在 DisplayRegistry 中声明 `paletteMeta`（图标、拖拽行为、快捷键），以保持左栏配置化。

### 3.8 侧边栏模式与模型

1. **模式切换**：
   - 「生成」模式：面向白板写入，支持文本/文件输入、模板选择，生成结果实时落盘。
   - 「对话」模式：纯问答，不修改白板；可针对选区提问（调用 `get_canvas_state`），回答以 Markdown 输出。
   - 模式切换保留历史消息，但区分存档，方便回溯。
2. **模型选择（规划）**：
   - 底部输入框左侧保留「模型」标签，列出默认模型与不同成本/速度的备选（示例：Qwen 3 Max、DeepSeek-R1）。
   - 后端暂只接入默认模型，但在 UI/配置上预留字段，便于后期放量。
3. **流式反馈**：不同模式都沿用 SSE，顶部展示模型名称与生成状态，用户可随时中止或切换模式。

---

## 4. 分阶段实施路径

| 阶段 | 目标 | 关键任务 |
| --- | --- | --- |
| Phase A：数据打通 | Mindmap 节点进入 Excalidraw | 1) Mindmap → Excalidraw 转换器；2) Frame 元素与 metadata 结构；3) AI 生成 → 画布落地流程更新；4) 回写 MindElixir。 |
| Phase B：交互升级 | 支持基础编辑 | 1) 工具栏模式切换；2) 快捷键（Tab/Enter、Delete）；3) 节点拖拽/复制/粘贴；4) Frame 拖拽联动。 |
| Phase C：样式 & 面板 | 对齐 BoardMix/XMind | 1) 左侧样式面板；2) 布局切换（左右/鱼骨）；3) 主题配色包；4) 节点批量操作。 |
| Phase D：多 Display 协同 | 流程图 + Mindmap 场景 | 1) 混合选区策略；2) Frame 分层控制；3) 导出/分享统一化；4) Undo/Redo/协作验证。 |

每阶段需产出：设计稿、技术方案、测试用例、埋点/监控计划。

---

## 5. 参考与启示

- **BoardMix**：无限画布 + AI Mind Map；节点可直接编辑，支持主题切换、快捷加分支；采用浮动 toolbar + 左侧风格面板。
- **XMind**：提供逻辑图、鱼骨、时间线等布局，以及多主题配色与图标；节点编辑快捷键成熟，可作为交互模板。
- **开源参考**：
  - [React Flow](https://reactflow.dev/) + 自定义节点，可构建 Mindmap；
  - [Mind-Graph](https://github.com/wa0x6e/mind-graph) 等项目实现了节点层级布局算法，可复用布局逻辑。

---

## 6. 技术风险与应对

| 风险 | 影响 | 缓解措施 |
| --- | --- | --- |
| Excalidraw 元素数量增加 | 复杂 Mindmap 可能导致性能下降 | 控制默认节点数（≤150），启用虚拟化/懒渲染；必要时拆分为分段加载 |
| 布局冲突 | Mindmap 与 Flowchart 元素重叠 | Frame 提供快速“整理”按钮，自动重排 Mindmap；提供锁定/隐藏 Frame 功能 |
| 同步一致性 | 画布 → MindElixir ←→ 数据库 多向同步复杂 | 采用 metadata hash 校验；保存前 diff 变化，仅写 Mindmap 区域；引入单元测试覆盖转换逻辑 |
| 工具栏状态管理 | 模式切换频繁，易造成 UX 混乱 | 统一 selection store，根据元素 metadata 判断；提供视觉提示（工具栏颜色/标签） |

---

## 7. 验收与测试

1. **功能测试**：
   - AI 生成 Mindmap 后，所有节点可在白板直接编辑、拖拽；
   - 工具栏根据选区类型切换；
   - Frame 可整体移动且保持透明背景；
   - 保存/刷新后 Mindmap 与 Flowchart 均可恢复。
2. **兼容性**：
   - 不影响仅使用流程图的用户；
   - 移动端/小屏保障基本查看能力。
3. **性能指标**：
   - 100 节点 Mindmap 渲染 < 200ms；交互无明显掉帧。
4. **UX 验证**：对照 BoardMix/XMind 的关键交互（快捷键、样式面板、主题切换），完成可用性走查。

---

> 注：本方案为实施前规划文档，确认后可进入设计评审与迭代开发。

## 8. 差异化与后续创新

1. **教育模板优先**：以“课堂脚本 Mindmap”“论文流程图”“学科知识树”“学习任务 Flowchart”作为首批模板，突出 ViLearning 在教育场景的深耕，与 BoardMix 的通用协作区分。
2. **AI 学习闭环**：Mindmap 与 Quiz/复盘笔记共享 `contexts` 数据，实现“生成 → 学习 → 检测”的整合，后续计划在白板上直接发起测验显示。
3. **上下文记忆**：依托 `contexts` 表实现“AI 记忆”，当用户扩写任意节点时可自动引用历史导图/文档片段，这是 BoardMix 目前未强调的独特点。
4. **轻量协作渐进式引入**：在 Phase D 以后引入协同游标/评论，但在此之前聚焦单人深度创作体验，确保性能和编辑能力扎实。
