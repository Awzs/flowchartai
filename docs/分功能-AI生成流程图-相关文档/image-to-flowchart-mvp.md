# 图片转流程图 MVP 方案

## 目标与成功标准
- **目标**：用户上传一张流程图图片后，系统自动生成可编辑的 Mermaid 流程图并渲染到画布。
- **成功标准**
  1. ≥70% 的清晰流程图照片能输出结构合法的 Mermaid。
  2. 模型判断图片不像流程图时，仍产出一版草稿流程图，并在回复中说明情况。
  3. 端到端（上传→渲染）平均响应时间 < 20 秒。

## 范围与约束
- 仅支持单张 JPG/PNG 图片，最大 5 MB。
- 仅做全量替换（replace），不支持叠加/局部扩展。
- 成功结果输出 Mermaid；暂不返回结构化 JSON。
- 不做复杂纠错，失败时提示用户上传更清晰图片或改用文字描述。

## 用户流程
1. 用户在 AI 侧边栏选择模式（文本生成 / 图片生成）。
2. 上传 1 张流程图图片（或输入文本），可选附带说明。
3. 前端展示“识别 → 生成 → 渲染”三个阶段的进度提示。
4. 识别成功：回复展示解析说明与关键节点摘要，并自动调用 `generate_flowchart` 将 Mermaid 落地至画布。
5. 识别为非流程图：仍生成一份推测流程图，并在回复里说明“原图不像流程图，我先整理一版草稿供参考”。
6. 解析失败：提示失败原因及改进建议。

## 技术方案

### 模型调用
- **触发条件**：消息中包含图片、且不超过 1 张。
- **使用模型**：`google/gemini-2.5-flash`。
- **系统提示核心要求**
  - 识别流程节点、箭头及文字。
  - 根据模式（见下一节）按结构返回 JSON：
    ```json
    {
      "mermaid": "flowchart LR ...",
      "title": "可选标题",
      "notes": "若原图不像流程图，请在此说明"
    }
    ```
  - MVP 阶段提示词保持简洁，确保能返回上述结构即可；后续再按测试反馈迭代。
- **后处理**
  - JSON 解析失败 → 返回错误提示。
  - `mermaid` 缺失或不含 `flowchart/graph` → 视为失败。
  - 简易正则校验 Mermaid；失败时提示用户重试。

### 模式控制（方案 A）
- 前端在侧边栏提供模式切换按钮，显式选择 `text_to_flowchart` 或 `image_to_flowchart`。
- 请求时新增 `aiContext.mode` 字段，值由用户选择决定。
- 后端在 `/api/ai/chat/flowchart/route.ts` 内根据 `mode` 选择提示词与处理逻辑：
  - `text_to_flowchart`：维持现有流程。
  - `image_to_flowchart`：触发图片处理分支，必须输出上述 JSON。
- 使用记录与日志中附带 `mode`，方便统计与限流策略。

### 后端改动（`src/app/api/ai/chat/flowchart/route.ts`）
- 在解析请求体时读取 `aiContext.mode`：
  1. `mode === 'image_to_flowchart'` 时，验证消息中仅有 1 张图片，拼装专用系统提示。
  2. 调用模型并解析 JSON；成功则构造 `generate_flowchart` 工具调用（mode 固定 `replace`，description 取 `title/notes`）。
  3. 若 `notes` 提示非流程图，在 SSE 文本里同步给前端。
- 错误处理：捕获 JSON/网络错误，记录日志，并返回统一错误响应。
- 使用记录：在 `recordAIUsage` 元数据中标记 `{ mode: 'image_to_flowchart', hasImage: true }`。

### 前端改动（`src/components/canvas/ai-chat-sidebar.tsx`）
- 新增模式切换 UI，默认显示文本模式，可手动切换到图片模式。
- 发送请求时按选择的模式设置 `aiContext.mode`：
  - 选择文本模式 → `text_to_flowchart`。
  - 选择图片模式 → `image_to_flowchart`。
- 图片模式下仅允许单张图片上传，保留大小校验。
- 根据 SSE 信息显示“识别中/生成中/渲染中”状态。
- 将模型文本答复以 Markdown 呈现，遇到“非流程图”提示时高亮。
- 沿用现有 `addFlowchartToCanvas` 将 Mermaid 渲染到画布。

## 开发计划
1. **确定模式与接口（0.5 天）**
   - 设计前端模式切换 UI 与交互。
   - 更新前后端接口定义，支持 `aiContext.mode`。
   - 规划最小提示词模板与 JSON 输出结构。
2. **后端实现（1.5 天）**
   - 在 `route.ts` 中实现图片分支与模型调用逻辑。
   - 解析模型 JSON，构造 `generate_flowchart` 调用，补充错误处理/日志。
3. **前端接入（1 天）**
   - 接入模式切换按钮，限制图片模式仅允许单图上传并设置 `mode`。
   - 增加状态提示与“非流程图”文案。
   - 验证画布渲染链路。
4. **自测与灰度准备（0.5 天）**
   - 端到端跑通典型图片，确认返回结构与 UI 行为。
   - 整理测试注意事项，交付给后续测试流程。

## 测试计划

| 场景            | 样例                         | 预期结果                                  |
| --------------- | ---------------------------- | ----------------------------------------- |
| 清晰矢量流程图  | draw.io 导出的 PNG            | Mermaid 结构正确，节点/连线准确率 ≥80%    |
| 黑白手绘扫描    | 手绘矩形/箭头/文字           | Mermaid 可渲染，节点可少量命名偏差        |
| 非流程图图片    | 组织架构或流程文字说明照片   | 生成推测流程，并提示“原图不像流程图”      |
| 低质量模糊照片  | 拍摄有反光、低清晰度的白板   | 返回失败提示，建议重新拍摄                |
| 超出规格        | 大于 5 MB 或多张图片         | 前端直接拒绝上传                          |

## 上线节奏与后续迭代
1. 本地/内部环境联调，整理成功与失败样例。
2. 小范围灰度给团队使用，收集问题并快速调整提示词或校验逻辑。
3. MVP 后续方向：
   - 多图/白板拼贴支持。
   - 输出结构化 JSON + 节点编辑器。
   - 复杂背景的 OCR/预处理增强。
   - 反馈数据闭环与模型调优。

