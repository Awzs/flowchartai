# Flowchart AI 增量生成优化记录

> 更新时间：2025-10-01

## 目标

确保 AI 生成流程图时能够正确区分 `replace` 与 `extend` 模式，复用历史内容，避免重复叠加，并在每次生成后保持画布与持久化状态一致。

## 优化步骤

1. **补齐上下文采集**  
   - **当前真实画布快照**：在调用 AI 前从 Excalidraw 提取节点、文本、连线、坐标等结构化信息，构成 `canvasSnapshot`，确保包含用户手动修改后的实际状态。  
   - **上一轮 AI Mermaid（若存在）**：保留最近一次生成的 Mermaid 字符串以及生成时间、关联元素，用于模型参考；如果用户已显著修改，仍以 `canvasSnapshot` 为准。  
   - **统一上下文 payload**：前端在请求体内补充 `aiContext = { canvasSnapshot, lastMermaid }`，后端将其插入系统提示或额外消息，使模型理解当前图形并据此决定 `replace`/`extend`。  
   - **基础实现步骤**：
     1. 扩展 `getCanvasState()`，输出结构化节点/连线列表，而非仅文本描述。
     2. 维持一份 `lastMermaid` 缓存（生成时更新，清空或标记过期由业务决定）。
     3. 前端在调用 `/api/ai/chat/flowchart` 时携带 `aiContext`；后端解析后补入 Prompt，指导模型基于当前真实状态增量绘制。

2. **调整 Prompt 与模式协议**  
   - 改造系统提示，明确区分 replace / extend 的触发条件。  
   - 在会话消息中附加：上一版 Mermaid、用户新需求、精简画布描述，指导模型按模式生成。

3. **完善前端合并逻辑**  
   - `replace`：移除所有 AI 元素，再落地最新输出。  
   - `extend`：基于节点标识做合并或去重，必要时对新旧元素位置微调，避免简单拼接。

4. **回路验证与调试**  
   - 用“新增分支”“修改节点”“局部扩展”等典型例子手动验证生成结果。  
   - 根据反馈迭代 Prompt 或合并策略，保证体验稳定。

5. **自动保存与提示**  
   - 在成功生成后触发保存或提醒用户保存，避免画布内容丢失。  
   - 明确提示“已替换 / 已扩展”，提高操作可理解性。

## 补充说明

- 当前复杂流程图（节点过多）问题尚不突出，可待后续用户反馈再评估。  
- 若 Prompt 调整仍不足以避免叠加，可在 extend 流程中引入差异比对或图结构校验。
